<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - trace.lcov_info_final - ghostpdlcoverage/devices/vector/gdevpdfk.c</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">ghostpdlcoverage/devices/vector</a> - gdevpdfk.c<span style="font-size: 80%;"> (source / <a href="gdevpdfk.c.func-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">trace.lcov_info_final</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryLo">0.0&nbsp;%</td>
            <td class="headerCovTableEntry">534</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2025-08-13 17:34:16</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryLo">0.0&nbsp;%</td>
            <td class="headerCovTableEntry">18</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
                  <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">            Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>              : /* Copyright (C) 2001-2023 Artifex Software, Inc.</span>
<span id="L2"><span class="lineNum">       2</span>              :    All Rights Reserved.</span>
<span id="L3"><span class="lineNum">       3</span>              : </span>
<span id="L4"><span class="lineNum">       4</span>              :    This software is provided AS-IS with no warranty, either express or</span>
<span id="L5"><span class="lineNum">       5</span>              :    implied.</span>
<span id="L6"><span class="lineNum">       6</span>              : </span>
<span id="L7"><span class="lineNum">       7</span>              :    This software is distributed under license and may not be copied,</span>
<span id="L8"><span class="lineNum">       8</span>              :    modified or distributed except as expressly authorized under the terms</span>
<span id="L9"><span class="lineNum">       9</span>              :    of the license contained in the file LICENSE in this distribution.</span>
<span id="L10"><span class="lineNum">      10</span>              : </span>
<span id="L11"><span class="lineNum">      11</span>              :    Refer to licensing information at http://www.artifex.com or contact</span>
<span id="L12"><span class="lineNum">      12</span>              :    Artifex Software, Inc.,  39 Mesa Street, Suite 108A, San Francisco,</span>
<span id="L13"><span class="lineNum">      13</span>              :    CA 94129, USA, for further information.</span>
<span id="L14"><span class="lineNum">      14</span>              : */</span>
<span id="L15"><span class="lineNum">      15</span>              : </span>
<span id="L16"><span class="lineNum">      16</span>              : </span>
<span id="L17"><span class="lineNum">      17</span>              : /* Lab and ICCBased color space writing */</span>
<span id="L18"><span class="lineNum">      18</span>              : #include &quot;math_.h&quot;</span>
<span id="L19"><span class="lineNum">      19</span>              : #include &quot;memory_.h&quot;</span>
<span id="L20"><span class="lineNum">      20</span>              : #include &quot;gx.h&quot;</span>
<span id="L21"><span class="lineNum">      21</span>              : #include &quot;gxcspace.h&quot;</span>
<span id="L22"><span class="lineNum">      22</span>              : #include &quot;stream.h&quot;</span>
<span id="L23"><span class="lineNum">      23</span>              : #include &quot;gsicc.h&quot;</span>
<span id="L24"><span class="lineNum">      24</span>              : #include &quot;gserrors.h&quot;</span>
<span id="L25"><span class="lineNum">      25</span>              : #include &quot;gxcie.h&quot;</span>
<span id="L26"><span class="lineNum">      26</span>              : #include &quot;gdevpdfx.h&quot;</span>
<span id="L27"><span class="lineNum">      27</span>              : #include &quot;gdevpdfg.h&quot;</span>
<span id="L28"><span class="lineNum">      28</span>              : #include &quot;gdevpdfc.h&quot;</span>
<span id="L29"><span class="lineNum">      29</span>              : #include &quot;gdevpdfo.h&quot;</span>
<span id="L30"><span class="lineNum">      30</span>              : #include &quot;strimpl.h&quot;</span>
<span id="L31"><span class="lineNum">      31</span>              : #include &quot;gsicc_create.h&quot;</span>
<span id="L32"><span class="lineNum">      32</span>              : #include &quot;gsicc_manage.h&quot;</span>
<span id="L33"><span class="lineNum">      33</span>              : </span>
<span id="L34"><span class="lineNum">      34</span>              : /* ------ CIE space synthesis ------ */</span>
<span id="L35"><span class="lineNum">      35</span>              : </span>
<span id="L36"><span class="lineNum">      36</span>              : /* Add a /Range entry to a CIE-based color space dictionary. */</span>
<span id="L37"><span class="lineNum">      37</span>              : static int</span>
<span id="L38"><span class="lineNum">      38</span> <span class="tlaUNC tlaBgUNC">           0 : pdf_cie_add_ranges(gx_device_pdf *pdev, cos_dict_t *pcd, const gs_range *prange, int n, bool clamp)</span></span>
<span id="L39"><span class="lineNum">      39</span>              : {</span>
<span id="L40"><span class="lineNum">      40</span> <span class="tlaUNC">           0 :     cos_array_t *pca = cos_array_alloc(pdev, &quot;pdf_cie_add_ranges&quot;);</span></span>
<span id="L41"><span class="lineNum">      41</span> <span class="tlaUNC">           0 :     int code = 0, i;</span></span>
<span id="L42"><span class="lineNum">      42</span>              : </span>
<span id="L43"><span class="lineNum">      43</span> <span class="tlaUNC">           0 :     if (pca == 0)</span></span>
<span id="L44"><span class="lineNum">      44</span>              :         return_error(gs_error_VMerror);</span>
<span id="L45"><span class="lineNum">      45</span> <span class="tlaUNC">           0 :     for (i = 0; i &lt; n; ++i) {</span></span>
<span id="L46"><span class="lineNum">      46</span> <span class="tlaUNC">           0 :         double rmin = prange[i].rmin, rmax = prange[i].rmax;</span></span>
<span id="L47"><span class="lineNum">      47</span>              : </span>
<span id="L48"><span class="lineNum">      48</span> <span class="tlaUNC">           0 :         if (clamp) {</span></span>
<span id="L49"><span class="lineNum">      49</span> <span class="tlaUNC">           0 :             if (rmin &lt; 0) rmin = 0;</span></span>
<span id="L50"><span class="lineNum">      50</span> <span class="tlaUNC">           0 :             if (rmax &gt; 1) rmax = 1;</span></span>
<span id="L51"><span class="lineNum">      51</span>              :         }</span>
<span id="L52"><span class="lineNum">      52</span> <span class="tlaUNC">           0 :         if ((code = cos_array_add_real(pca, rmin)) &lt; 0 ||</span></span>
<span id="L53"><span class="lineNum">      53</span> <span class="tlaUNC">           0 :             (code = cos_array_add_real(pca, rmax)) &lt; 0</span></span>
<span id="L54"><span class="lineNum">      54</span>              :             )</span>
<span id="L55"><span class="lineNum">      55</span>              :             break;</span>
<span id="L56"><span class="lineNum">      56</span>              :     }</span>
<span id="L57"><span class="lineNum">      57</span> <span class="tlaUNC">           0 :     if (code &gt;= 0)</span></span>
<span id="L58"><span class="lineNum">      58</span> <span class="tlaUNC">           0 :         code = cos_dict_put_c_key_object(pcd, &quot;/Range&quot;, COS_OBJECT(pca));</span></span>
<span id="L59"><span class="lineNum">      59</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L60"><span class="lineNum">      60</span> <span class="tlaUNC">           0 :         COS_FREE(pca, &quot;pdf_cie_add_ranges&quot;);</span></span>
<span id="L61"><span class="lineNum">      61</span>              :     return code;</span>
<span id="L62"><span class="lineNum">      62</span>              : }</span>
<span id="L63"><span class="lineNum">      63</span>              : </span>
<span id="L64"><span class="lineNum">      64</span>              : /* Transform a CIEBased color to XYZ. */</span>
<span id="L65"><span class="lineNum">      65</span>              : static int</span>
<span id="L66"><span class="lineNum">      66</span> <span class="tlaUNC">           0 : cie_to_xyz(const double *in, double out[3], const gs_color_space *pcs,</span></span>
<span id="L67"><span class="lineNum">      67</span>              :            const gs_gstate *pgs, const gs_cie_common *pciec)</span>
<span id="L68"><span class="lineNum">      68</span>              : {</span>
<span id="L69"><span class="lineNum">      69</span> <span class="tlaUNC">           0 :     gs_client_color cc;</span></span>
<span id="L70"><span class="lineNum">      70</span> <span class="tlaUNC">           0 :     frac xyz[3];</span></span>
<span id="L71"><span class="lineNum">      71</span> <span class="tlaUNC">           0 :     int ncomp = gs_color_space_num_components(pcs);</span></span>
<span id="L72"><span class="lineNum">      72</span> <span class="tlaUNC">           0 :     int i;</span></span>
<span id="L73"><span class="lineNum">      73</span>              : </span>
<span id="L74"><span class="lineNum">      74</span> <span class="tlaUNC">           0 :     gs_color_space_index cs_index;</span></span>
<span id="L75"><span class="lineNum">      75</span> <span class="tlaUNC">           0 :     const gs_vector3 *const pWhitePoint = &amp;pciec-&gt;points.WhitePoint;</span></span>
<span id="L76"><span class="lineNum">      76</span> <span class="tlaUNC">           0 :     float xyz_float[3];</span></span>
<span id="L77"><span class="lineNum">      77</span>              : </span>
<span id="L78"><span class="lineNum">      78</span> <span class="tlaUNC">           0 :     cs_index = gs_color_space_get_index(pcs);</span></span>
<span id="L79"><span class="lineNum">      79</span>              : </span>
<span id="L80"><span class="lineNum">      80</span> <span class="tlaUNC">           0 :     for (i = 0; i &lt; ncomp; ++i)</span></span>
<span id="L81"><span class="lineNum">      81</span> <span class="tlaUNC">           0 :         cc.paint.values[i] = in[i];</span></span>
<span id="L82"><span class="lineNum">      82</span>              : </span>
<span id="L83"><span class="lineNum">      83</span>              :     /* The standard concretization makes use of the equivalent ICC profile</span>
<span id="L84"><span class="lineNum">      84</span>              :        to ensure that all color management is handled by the CMM.</span>
<span id="L85"><span class="lineNum">      85</span>              :        Unfortunately, we can't do that here since we have no access to the</span>
<span id="L86"><span class="lineNum">      86</span>              :        icc manager.  Also the PDF write outputs have restrictions on the</span>
<span id="L87"><span class="lineNum">      87</span>              :        ICC profiles that can be embedded so we must use this older form.</span>
<span id="L88"><span class="lineNum">      88</span>              :        Need to add an ICC version number into the icc creator to enable</span>
<span id="L89"><span class="lineNum">      89</span>              :        creation to and from various versions */</span>
<span id="L90"><span class="lineNum">      90</span>              : </span>
<span id="L91"><span class="lineNum">      91</span> <span class="tlaUNC">           0 :     switch (cs_index) {</span></span>
<span id="L92"><span class="lineNum">      92</span> <span class="tlaUNC">           0 :         case gs_color_space_index_CIEA:</span></span>
<span id="L93"><span class="lineNum">      93</span> <span class="tlaUNC">           0 :             gx_psconcretize_CIEA(&amp;cc, pcs, xyz, xyz_float, pgs);</span></span>
<span id="L94"><span class="lineNum">      94</span> <span class="tlaUNC">           0 :             break;</span></span>
<span id="L95"><span class="lineNum">      95</span> <span class="tlaUNC">           0 :         case gs_color_space_index_CIEABC:</span></span>
<span id="L96"><span class="lineNum">      96</span> <span class="tlaUNC">           0 :             gx_psconcretize_CIEABC(&amp;cc, pcs, xyz, xyz_float, pgs);</span></span>
<span id="L97"><span class="lineNum">      97</span> <span class="tlaUNC">           0 :             break;</span></span>
<span id="L98"><span class="lineNum">      98</span> <span class="tlaUNC">           0 :         case gs_color_space_index_CIEDEF:</span></span>
<span id="L99"><span class="lineNum">      99</span> <span class="tlaUNC">           0 :             gx_psconcretize_CIEDEF(&amp;cc, pcs, xyz, xyz_float, pgs);</span></span>
<span id="L100"><span class="lineNum">     100</span> <span class="tlaUNC">           0 :             break;</span></span>
<span id="L101"><span class="lineNum">     101</span> <span class="tlaUNC">           0 :         case gs_color_space_index_CIEDEFG:</span></span>
<span id="L102"><span class="lineNum">     102</span> <span class="tlaUNC">           0 :            gx_psconcretize_CIEDEFG(&amp;cc, pcs, xyz, xyz_float, pgs);</span></span>
<span id="L103"><span class="lineNum">     103</span> <span class="tlaUNC">           0 :            break;</span></span>
<span id="L104"><span class="lineNum">     104</span>              :         default:</span>
<span id="L105"><span class="lineNum">     105</span>              :             /* Only to silence a Coverity uninitialised variable warning */</span>
<span id="L106"><span class="lineNum">     106</span> <span class="tlaUNC">           0 :             memset(&amp;xyz_float, 0x00, sizeof(xyz_float));</span></span>
<span id="L107"><span class="lineNum">     107</span> <span class="tlaUNC">           0 :             break;</span></span>
<span id="L108"><span class="lineNum">     108</span>              :     }</span>
<span id="L109"><span class="lineNum">     109</span> <span class="tlaUNC">           0 :     if (cs_index == gs_color_space_index_CIEA) {</span></span>
<span id="L110"><span class="lineNum">     110</span>              :         /* AR forces this case to always be achromatic.  We will</span>
<span id="L111"><span class="lineNum">     111</span>              :         do the same even though it does not match the PS</span>
<span id="L112"><span class="lineNum">     112</span>              :         specification */</span>
<span id="L113"><span class="lineNum">     113</span>              :         /* Use the resulting Y value to scale the wp Illumination.</span>
<span id="L114"><span class="lineNum">     114</span>              :         note that we scale to the whitepoint here.  Matrix out</span>
<span id="L115"><span class="lineNum">     115</span>              :         handles mapping to CIE D50.  This forces an achromatic result */</span>
<span id="L116"><span class="lineNum">     116</span> <span class="tlaUNC">           0 :         xyz_float[0] = pWhitePoint-&gt;u * xyz_float[1];</span></span>
<span id="L117"><span class="lineNum">     117</span> <span class="tlaUNC">           0 :         xyz_float[2] = pWhitePoint-&gt;w * xyz_float[1];</span></span>
<span id="L118"><span class="lineNum">     118</span>              :     }</span>
<span id="L119"><span class="lineNum">     119</span>              : </span>
<span id="L120"><span class="lineNum">     120</span>              :     /* Do wp mapping to D50 in XYZ for now.  We should do bradford correction.</span>
<span id="L121"><span class="lineNum">     121</span>              :        Will add that in next release */</span>
<span id="L122"><span class="lineNum">     122</span> <span class="tlaUNC">           0 :     out[0] = xyz_float[0]*0.9642/pWhitePoint-&gt;u;</span></span>
<span id="L123"><span class="lineNum">     123</span> <span class="tlaUNC">           0 :     out[1] = xyz_float[1];</span></span>
<span id="L124"><span class="lineNum">     124</span> <span class="tlaUNC">           0 :     out[2] = xyz_float[2]*0.8249/pWhitePoint-&gt;w;</span></span>
<span id="L125"><span class="lineNum">     125</span> <span class="tlaUNC">           0 :     return 0;</span></span>
<span id="L126"><span class="lineNum">     126</span>              : }</span>
<span id="L127"><span class="lineNum">     127</span>              : </span>
<span id="L128"><span class="lineNum">     128</span>              : /* ------ Lab space writing and synthesis ------ */</span>
<span id="L129"><span class="lineNum">     129</span>              : </span>
<span id="L130"><span class="lineNum">     130</span>              : /* Transform XYZ values to Lab. */</span>
<span id="L131"><span class="lineNum">     131</span>              : static double</span>
<span id="L132"><span class="lineNum">     132</span>              : lab_g_inverse(double v)</span>
<span id="L133"><span class="lineNum">     133</span>              : {</span>
<span id="L134"><span class="lineNum">     134</span>              :     if (v &gt;= (6.0 * 6.0 * 6.0) / (29 * 29 * 29))</span>
<span id="L135"><span class="lineNum">     135</span>              :         return pow(v, 1.0 / 3); /* use cbrt if available? */</span>
<span id="L136"><span class="lineNum">     136</span>              :     else</span>
<span id="L137"><span class="lineNum">     137</span>              :         return (v * (841.0 / 108) + 4.0 / 29);</span>
<span id="L138"><span class="lineNum">     138</span>              : }</span>
<span id="L139"><span class="lineNum">     139</span>              : static void</span>
<span id="L140"><span class="lineNum">     140</span>              : xyz_to_lab(const double xyz[3], double lab[3], const gs_cie_common *pciec)</span>
<span id="L141"><span class="lineNum">     141</span>              : {</span>
<span id="L142"><span class="lineNum">     142</span>              :     const gs_vector3 *const pWhitePoint = &amp;pciec-&gt;points.WhitePoint;</span>
<span id="L143"><span class="lineNum">     143</span>              :     double L, lunit;</span>
<span id="L144"><span class="lineNum">     144</span>              : </span>
<span id="L145"><span class="lineNum">     145</span>              :     /* Calculate L* first. */</span>
<span id="L146"><span class="lineNum">     146</span>              :     L = lab_g_inverse(xyz[1] / pWhitePoint-&gt;v) * 116 - 16;</span>
<span id="L147"><span class="lineNum">     147</span>              :     /* Clamp L* to the PDF range [0..100]. */</span>
<span id="L148"><span class="lineNum">     148</span>              :     if (L &lt; 0)</span>
<span id="L149"><span class="lineNum">     149</span>              :         L = 0;</span>
<span id="L150"><span class="lineNum">     150</span>              :     else if (L &gt; 100)</span>
<span id="L151"><span class="lineNum">     151</span>              :         L = 100;</span>
<span id="L152"><span class="lineNum">     152</span>              :     lab[1] = L;</span>
<span id="L153"><span class="lineNum">     153</span>              :     lunit = (L + 16) / 116;</span>
<span id="L154"><span class="lineNum">     154</span>              : </span>
<span id="L155"><span class="lineNum">     155</span>              :     /* Calculate a* and b*. */</span>
<span id="L156"><span class="lineNum">     156</span>              :     lab[0] = (lab_g_inverse(xyz[0] / pWhitePoint-&gt;u) - lunit) * 500;</span>
<span id="L157"><span class="lineNum">     157</span>              :     lab[2] = (lab_g_inverse(xyz[2] / pWhitePoint-&gt;w) - lunit) * -200;</span>
<span id="L158"><span class="lineNum">     158</span>              : }</span>
<span id="L159"><span class="lineNum">     159</span>              : </span>
<span id="L160"><span class="lineNum">     160</span>              : /* Create a PDF Lab color space corresponding to a CIEBased color space. */</span>
<span id="L161"><span class="lineNum">     161</span>              : static int</span>
<span id="L162"><span class="lineNum">     162</span>              : lab_range(gs_range range_out[3] /* only [1] and [2] used */,</span>
<span id="L163"><span class="lineNum">     163</span>              :           const gs_color_space *pcs, const gs_cie_common *pciec,</span>
<span id="L164"><span class="lineNum">     164</span>              :           const gs_range *ranges, gs_memory_t *mem)</span>
<span id="L165"><span class="lineNum">     165</span>              : {</span>
<span id="L166"><span class="lineNum">     166</span>              :     /*</span>
<span id="L167"><span class="lineNum">     167</span>              :      * Determine the range of a* and b* by evaluating the color space</span>
<span id="L168"><span class="lineNum">     168</span>              :      * mapping at all of its extrema.</span>
<span id="L169"><span class="lineNum">     169</span>              :      */</span>
<span id="L170"><span class="lineNum">     170</span>              :     int ncomp = gs_color_space_num_components(pcs);</span>
<span id="L171"><span class="lineNum">     171</span>              :     gs_gstate *pgs;</span>
<span id="L172"><span class="lineNum">     172</span>              :     int code = gx_cie_to_xyz_alloc(&amp;pgs, pcs, mem);</span>
<span id="L173"><span class="lineNum">     173</span>              :     int i, j;</span>
<span id="L174"><span class="lineNum">     174</span>              : </span>
<span id="L175"><span class="lineNum">     175</span>              :     if (code &lt; 0)</span>
<span id="L176"><span class="lineNum">     176</span>              :         return code;</span>
<span id="L177"><span class="lineNum">     177</span>              :     for (j = 1; j &lt; 3; ++j)</span>
<span id="L178"><span class="lineNum">     178</span>              :         range_out[j].rmin = 1000.0, range_out[j].rmax = -1000.0;</span>
<span id="L179"><span class="lineNum">     179</span>              :     for (i = 0; i &lt; 1 &lt;&lt; ncomp; ++i) {</span>
<span id="L180"><span class="lineNum">     180</span>              :         double in[4], xyz[3];</span>
<span id="L181"><span class="lineNum">     181</span>              : </span>
<span id="L182"><span class="lineNum">     182</span>              :         for (j = 0; j &lt; ncomp; ++j)</span>
<span id="L183"><span class="lineNum">     183</span>              :             in[j] = (i &amp; (1 &lt;&lt; j) ? ranges[j].rmax : ranges[j].rmin);</span>
<span id="L184"><span class="lineNum">     184</span>              :         if (cie_to_xyz(in, xyz, pcs, pgs, pciec) &gt;= 0) {</span>
<span id="L185"><span class="lineNum">     185</span>              :             double lab[3];</span>
<span id="L186"><span class="lineNum">     186</span>              : </span>
<span id="L187"><span class="lineNum">     187</span>              :             xyz_to_lab(xyz, lab, pciec);</span>
<span id="L188"><span class="lineNum">     188</span>              :             for (j = 1; j &lt; 3; ++j) {</span>
<span id="L189"><span class="lineNum">     189</span>              :                 range_out[j].rmin = min(range_out[j].rmin, lab[j]);</span>
<span id="L190"><span class="lineNum">     190</span>              :                 range_out[j].rmax = max(range_out[j].rmax, lab[j]);</span>
<span id="L191"><span class="lineNum">     191</span>              :             }</span>
<span id="L192"><span class="lineNum">     192</span>              :         }</span>
<span id="L193"><span class="lineNum">     193</span>              :     }</span>
<span id="L194"><span class="lineNum">     194</span>              :     gx_cie_to_xyz_free(pgs);</span>
<span id="L195"><span class="lineNum">     195</span>              :     return 0;</span>
<span id="L196"><span class="lineNum">     196</span>              : }</span>
<span id="L197"><span class="lineNum">     197</span>              : /*</span>
<span id="L198"><span class="lineNum">     198</span>              :  * Create a Lab color space object.</span>
<span id="L199"><span class="lineNum">     199</span>              :  * This procedure is exported for Lab color spaces in gdevpdfc.c.</span>
<span id="L200"><span class="lineNum">     200</span>              :  */</span>
<span id="L201"><span class="lineNum">     201</span>              : int</span>
<span id="L202"><span class="lineNum">     202</span> <span class="tlaUNC">           0 : pdf_put_lab_color_space(gx_device_pdf *pdev, cos_array_t *pca, cos_dict_t *pcd,</span></span>
<span id="L203"><span class="lineNum">     203</span>              :                         const gs_range ranges[3] /* only [1] and [2] used */)</span>
<span id="L204"><span class="lineNum">     204</span>              : {</span>
<span id="L205"><span class="lineNum">     205</span> <span class="tlaUNC">           0 :     int code;</span></span>
<span id="L206"><span class="lineNum">     206</span> <span class="tlaUNC">           0 :     cos_value_t v;</span></span>
<span id="L207"><span class="lineNum">     207</span>              : </span>
<span id="L208"><span class="lineNum">     208</span> <span class="tlaUNC">           0 :     if ((code = cos_array_add(pca, cos_c_string_value(&amp;v, &quot;/Lab&quot;))) &gt;= 0)</span></span>
<span id="L209"><span class="lineNum">     209</span> <span class="tlaUNC">           0 :         code = pdf_cie_add_ranges(pdev, pcd, ranges + 1, 2, false);</span></span>
<span id="L210"><span class="lineNum">     210</span> <span class="tlaUNC">           0 :     return code;</span></span>
<span id="L211"><span class="lineNum">     211</span>              : }</span>
<span id="L212"><span class="lineNum">     212</span>              : </span>
<span id="L213"><span class="lineNum">     213</span>              : /*</span>
<span id="L214"><span class="lineNum">     214</span>              :  * Create a Lab color space for a CIEBased space that can't be represented</span>
<span id="L215"><span class="lineNum">     215</span>              :  * directly as a Calxxx or Lab space.</span>
<span id="L216"><span class="lineNum">     216</span>              :  */</span>
<span id="L217"><span class="lineNum">     217</span>              : static int</span>
<span id="L218"><span class="lineNum">     218</span>              : pdf_convert_cie_to_lab(gx_device_pdf *pdev, cos_array_t *pca,</span>
<span id="L219"><span class="lineNum">     219</span>              :                        const gs_color_space *pcs,</span>
<span id="L220"><span class="lineNum">     220</span>              :                        const gs_cie_common *pciec, const gs_range *prange)</span>
<span id="L221"><span class="lineNum">     221</span>              : {</span>
<span id="L222"><span class="lineNum">     222</span>              :     cos_dict_t *pcd;</span>
<span id="L223"><span class="lineNum">     223</span>              :     gs_range ranges[3];</span>
<span id="L224"><span class="lineNum">     224</span>              :     int code;</span>
<span id="L225"><span class="lineNum">     225</span>              : </span>
<span id="L226"><span class="lineNum">     226</span>              :     /****** NOT IMPLEMENTED YET, REQUIRES TRANSFORMING VALUES ******/</span>
<span id="L227"><span class="lineNum">     227</span>              :     if (1) return_error(gs_error_rangecheck);</span>
<span id="L228"><span class="lineNum">     228</span>              :     pcd = cos_dict_alloc(pdev, &quot;pdf_convert_cie_to_lab(dict)&quot;);</span>
<span id="L229"><span class="lineNum">     229</span>              :     if (pcd == 0)</span>
<span id="L230"><span class="lineNum">     230</span>              :         return_error(gs_error_VMerror);</span>
<span id="L231"><span class="lineNum">     231</span>              :     if ((code = lab_range(ranges, pcs, pciec, prange, pdev-&gt;pdf_memory)) &lt; 0 ||</span>
<span id="L232"><span class="lineNum">     232</span>              :         (code = pdf_put_lab_color_space(pdev, pca, pcd, ranges)) &lt; 0 ||</span>
<span id="L233"><span class="lineNum">     233</span>              :         (code = pdf_finish_cie_space(pdev, pca, pcd, pciec)) &lt; 0</span>
<span id="L234"><span class="lineNum">     234</span>              :         )</span>
<span id="L235"><span class="lineNum">     235</span>              :         COS_FREE(pcd, &quot;pdf_convert_cie_to_lab(dict)&quot;);</span>
<span id="L236"><span class="lineNum">     236</span>              :     return code;</span>
<span id="L237"><span class="lineNum">     237</span>              : }</span>
<span id="L238"><span class="lineNum">     238</span>              : </span>
<span id="L239"><span class="lineNum">     239</span>              : /* ------ ICCBased space writing and synthesis ------ */</span>
<span id="L240"><span class="lineNum">     240</span>              : </span>
<span id="L241"><span class="lineNum">     241</span>              : /* Define standard and short color space names. */</span>
<span id="L242"><span class="lineNum">     242</span>              : const pdf_color_space_names_t base_names = {</span>
<span id="L243"><span class="lineNum">     243</span>              :     PDF_COLOR_SPACE_NAMES</span>
<span id="L244"><span class="lineNum">     244</span>              : };</span>
<span id="L245"><span class="lineNum">     245</span>              : </span>
<span id="L246"><span class="lineNum">     246</span> <span class="tlaUNC">           0 : static int put_calgray_color_space(gx_device_pdf *pdev, const gs_gstate * pgs, const gs_color_space *pcs, cos_array_t *pca)</span></span>
<span id="L247"><span class="lineNum">     247</span>              : {</span>
<span id="L248"><span class="lineNum">     248</span> <span class="tlaUNC">           0 :     int code;</span></span>
<span id="L249"><span class="lineNum">     249</span> <span class="tlaUNC">           0 :     cos_value_t v;</span></span>
<span id="L250"><span class="lineNum">     250</span> <span class="tlaUNC">           0 :     cos_dict_t *pcd;</span></span>
<span id="L251"><span class="lineNum">     251</span> <span class="tlaUNC">           0 :     cos_array_t *WP = NULL, *BP = NULL;</span></span>
<span id="L252"><span class="lineNum">     252</span>              : </span>
<span id="L253"><span class="lineNum">     253</span> <span class="tlaUNC">           0 :     pcd = cos_dict_alloc(pdev, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L254"><span class="lineNum">     254</span> <span class="tlaUNC">           0 :     if (pcd == NULL)</span></span>
<span id="L255"><span class="lineNum">     255</span>              :         return_error(gs_error_VMerror);</span>
<span id="L256"><span class="lineNum">     256</span>              : </span>
<span id="L257"><span class="lineNum">     257</span> <span class="tlaUNC">           0 :     WP = cos_array_from_floats(pdev, pcs-&gt;params.calgray.WhitePoint, 3,</span></span>
<span id="L258"><span class="lineNum">     258</span>              :                                              &quot;write_calgray_color_space&quot;);</span>
<span id="L259"><span class="lineNum">     259</span> <span class="tlaUNC">           0 :     if (WP == NULL) {</span></span>
<span id="L260"><span class="lineNum">     260</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L261"><span class="lineNum">     261</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L262"><span class="lineNum">     262</span>              :     }</span>
<span id="L263"><span class="lineNum">     263</span> <span class="tlaUNC">           0 :     BP = cos_array_from_floats(pdev, pcs-&gt;params.calgray.BlackPoint, 3,</span></span>
<span id="L264"><span class="lineNum">     264</span>              :                                              &quot;write_calgray_color_space&quot;);</span>
<span id="L265"><span class="lineNum">     265</span> <span class="tlaUNC">           0 :     if (BP == NULL) {</span></span>
<span id="L266"><span class="lineNum">     266</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L267"><span class="lineNum">     267</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)WP, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L268"><span class="lineNum">     268</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L269"><span class="lineNum">     269</span>              :     }</span>
<span id="L270"><span class="lineNum">     270</span>              : </span>
<span id="L271"><span class="lineNum">     271</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/BlackPoint&quot;, COS_OBJECT_VALUE(&amp;v, BP));</span></span>
<span id="L272"><span class="lineNum">     272</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L273"><span class="lineNum">     273</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L274"><span class="lineNum">     274</span>              : </span>
<span id="L275"><span class="lineNum">     275</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/WhitePoint&quot;,  COS_OBJECT_VALUE(&amp;v, WP));</span></span>
<span id="L276"><span class="lineNum">     276</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L277"><span class="lineNum">     277</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L278"><span class="lineNum">     278</span>              : </span>
<span id="L279"><span class="lineNum">     279</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key_real(pcd, &quot;/Gamma&quot;, pcs-&gt;params.calgray.Gamma);</span></span>
<span id="L280"><span class="lineNum">     280</span>              : </span>
<span id="L281"><span class="lineNum">     281</span> <span class="tlaUNC">           0 :     code = cos_array_add_c_string(pca, &quot;/CalGray&quot;);</span></span>
<span id="L282"><span class="lineNum">     282</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L283"><span class="lineNum">     283</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L284"><span class="lineNum">     284</span>              : </span>
<span id="L285"><span class="lineNum">     285</span> <span class="tlaUNC">           0 :     code = cos_array_add(pca,  COS_OBJECT_VALUE(&amp;v, pcd));</span></span>
<span id="L286"><span class="lineNum">     286</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L287"><span class="lineNum">     287</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L288"><span class="lineNum">     288</span>              : </span>
<span id="L289"><span class="lineNum">     289</span>              :     return 0;</span>
<span id="L290"><span class="lineNum">     290</span>              : </span>
<span id="L291"><span class="lineNum">     291</span> <span class="tlaUNC">           0 : error:</span></span>
<span id="L292"><span class="lineNum">     292</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L293"><span class="lineNum">     293</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)WP, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L294"><span class="lineNum">     294</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)BP, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L295"><span class="lineNum">     295</span> <span class="tlaUNC">           0 :     return code;</span></span>
<span id="L296"><span class="lineNum">     296</span>              : }</span>
<span id="L297"><span class="lineNum">     297</span>              : </span>
<span id="L298"><span class="lineNum">     298</span> <span class="tlaUNC">           0 : static int put_calrgb_color_space(gx_device_pdf *pdev, const gs_gstate * pgs, const gs_color_space *pcs, cos_array_t *pca)</span></span>
<span id="L299"><span class="lineNum">     299</span>              : {</span>
<span id="L300"><span class="lineNum">     300</span> <span class="tlaUNC">           0 :     int code;</span></span>
<span id="L301"><span class="lineNum">     301</span> <span class="tlaUNC">           0 :     cos_value_t v;</span></span>
<span id="L302"><span class="lineNum">     302</span> <span class="tlaUNC">           0 :     cos_dict_t *pcd = NULL;</span></span>
<span id="L303"><span class="lineNum">     303</span> <span class="tlaUNC">           0 :     cos_array_t *WP = NULL, *BP = NULL, *Gamma = NULL, *Matrix;</span></span>
<span id="L304"><span class="lineNum">     304</span>              : </span>
<span id="L305"><span class="lineNum">     305</span> <span class="tlaUNC">           0 :     pcd = cos_dict_alloc(pdev, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L306"><span class="lineNum">     306</span> <span class="tlaUNC">           0 :     if (pcd == NULL)</span></span>
<span id="L307"><span class="lineNum">     307</span>              :         return_error(gs_error_VMerror);</span>
<span id="L308"><span class="lineNum">     308</span>              : </span>
<span id="L309"><span class="lineNum">     309</span> <span class="tlaUNC">           0 :     WP = cos_array_from_floats(pdev, pcs-&gt;params.calrgb.WhitePoint, 3,</span></span>
<span id="L310"><span class="lineNum">     310</span>              :                                              &quot;write_calrgb_color_space&quot;);</span>
<span id="L311"><span class="lineNum">     311</span> <span class="tlaUNC">           0 :     if (WP == NULL) {</span></span>
<span id="L312"><span class="lineNum">     312</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L313"><span class="lineNum">     313</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L314"><span class="lineNum">     314</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L315"><span class="lineNum">     315</span>              :     }</span>
<span id="L316"><span class="lineNum">     316</span> <span class="tlaUNC">           0 :     BP = cos_array_from_floats(pdev, pcs-&gt;params.calrgb.BlackPoint, 3,</span></span>
<span id="L317"><span class="lineNum">     317</span>              :                                              &quot;write_calrgb_color_space&quot;);</span>
<span id="L318"><span class="lineNum">     318</span> <span class="tlaUNC">           0 :     if (BP == NULL) {</span></span>
<span id="L319"><span class="lineNum">     319</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L320"><span class="lineNum">     320</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)WP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L321"><span class="lineNum">     321</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L322"><span class="lineNum">     322</span>              :     }</span>
<span id="L323"><span class="lineNum">     323</span>              : </span>
<span id="L324"><span class="lineNum">     324</span> <span class="tlaUNC">           0 :     Gamma = cos_array_from_floats(pdev, pcs-&gt;params.calrgb.Gamma, 3,</span></span>
<span id="L325"><span class="lineNum">     325</span>              :                                              &quot;write_calrgb_color_space&quot;);</span>
<span id="L326"><span class="lineNum">     326</span> <span class="tlaUNC">           0 :     if (Gamma == NULL) {</span></span>
<span id="L327"><span class="lineNum">     327</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)BP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L328"><span class="lineNum">     328</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L329"><span class="lineNum">     329</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)WP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L330"><span class="lineNum">     330</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L331"><span class="lineNum">     331</span>              :     }</span>
<span id="L332"><span class="lineNum">     332</span>              : </span>
<span id="L333"><span class="lineNum">     333</span> <span class="tlaUNC">           0 :     Matrix = cos_array_from_floats(pdev, pcs-&gt;params.calrgb.Matrix, 9,</span></span>
<span id="L334"><span class="lineNum">     334</span>              :                                              &quot;write_calrgb_color_space&quot;);</span>
<span id="L335"><span class="lineNum">     335</span> <span class="tlaUNC">           0 :     if (Matrix == NULL) {</span></span>
<span id="L336"><span class="lineNum">     336</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)Gamma, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L337"><span class="lineNum">     337</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)BP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L338"><span class="lineNum">     338</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L339"><span class="lineNum">     339</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)WP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L340"><span class="lineNum">     340</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L341"><span class="lineNum">     341</span>              :     }</span>
<span id="L342"><span class="lineNum">     342</span>              : </span>
<span id="L343"><span class="lineNum">     343</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/BlackPoint&quot;, COS_OBJECT_VALUE(&amp;v, BP));</span></span>
<span id="L344"><span class="lineNum">     344</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L345"><span class="lineNum">     345</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L346"><span class="lineNum">     346</span>              : </span>
<span id="L347"><span class="lineNum">     347</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/WhitePoint&quot;,  COS_OBJECT_VALUE(&amp;v, WP));</span></span>
<span id="L348"><span class="lineNum">     348</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L349"><span class="lineNum">     349</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L350"><span class="lineNum">     350</span>              : </span>
<span id="L351"><span class="lineNum">     351</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/Gamma&quot;, COS_OBJECT_VALUE(&amp;v, Gamma));</span></span>
<span id="L352"><span class="lineNum">     352</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L353"><span class="lineNum">     353</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L354"><span class="lineNum">     354</span>              : </span>
<span id="L355"><span class="lineNum">     355</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/Matrix&quot;, COS_OBJECT_VALUE(&amp;v, Matrix));</span></span>
<span id="L356"><span class="lineNum">     356</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L357"><span class="lineNum">     357</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L358"><span class="lineNum">     358</span>              : </span>
<span id="L359"><span class="lineNum">     359</span> <span class="tlaUNC">           0 :     code = cos_array_add_c_string(pca, &quot;/CalRGB&quot;);</span></span>
<span id="L360"><span class="lineNum">     360</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L361"><span class="lineNum">     361</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L362"><span class="lineNum">     362</span>              : </span>
<span id="L363"><span class="lineNum">     363</span> <span class="tlaUNC">           0 :     code = cos_array_add(pca,  COS_OBJECT_VALUE(&amp;v, pcd));</span></span>
<span id="L364"><span class="lineNum">     364</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L365"><span class="lineNum">     365</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L366"><span class="lineNum">     366</span>              : </span>
<span id="L367"><span class="lineNum">     367</span>              : </span>
<span id="L368"><span class="lineNum">     368</span>              :     return 0;</span>
<span id="L369"><span class="lineNum">     369</span>              : </span>
<span id="L370"><span class="lineNum">     370</span> <span class="tlaUNC">           0 : error:</span></span>
<span id="L371"><span class="lineNum">     371</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)pcd, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L372"><span class="lineNum">     372</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)WP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L373"><span class="lineNum">     373</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)BP, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L374"><span class="lineNum">     374</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)Gamma, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L375"><span class="lineNum">     375</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)Matrix, &quot;write_calrgb_color_space&quot;);</span></span>
<span id="L376"><span class="lineNum">     376</span> <span class="tlaUNC">           0 :     return code;</span></span>
<span id="L377"><span class="lineNum">     377</span>              : }</span>
<span id="L378"><span class="lineNum">     378</span>              : </span>
<span id="L379"><span class="lineNum">     379</span> <span class="tlaUNC">           0 : static int put_lab_color_space(gx_device_pdf *pdev, const gs_gstate * pgs, const gs_color_space *pcs, cos_array_t *pca)</span></span>
<span id="L380"><span class="lineNum">     380</span>              : {</span>
<span id="L381"><span class="lineNum">     381</span> <span class="tlaUNC">           0 :     int code, i;</span></span>
<span id="L382"><span class="lineNum">     382</span> <span class="tlaUNC">           0 :     cos_value_t v;</span></span>
<span id="L383"><span class="lineNum">     383</span> <span class="tlaUNC">           0 :     cos_dict_t *pcd;</span></span>
<span id="L384"><span class="lineNum">     384</span> <span class="tlaUNC">           0 :     cos_array_t *WP = NULL, *BP = NULL, *range = NULL;</span></span>
<span id="L385"><span class="lineNum">     385</span>              : </span>
<span id="L386"><span class="lineNum">     386</span> <span class="tlaUNC">           0 :     pcd = cos_dict_alloc(pdev, &quot;write_lab_color_space&quot;);</span></span>
<span id="L387"><span class="lineNum">     387</span> <span class="tlaUNC">           0 :     if (pcd == NULL)</span></span>
<span id="L388"><span class="lineNum">     388</span>              :         return_error(gs_error_VMerror);</span>
<span id="L389"><span class="lineNum">     389</span>              : </span>
<span id="L390"><span class="lineNum">     390</span> <span class="tlaUNC">           0 :     range = cos_array_alloc(pdev, &quot;write_lab_color_space&quot;);</span></span>
<span id="L391"><span class="lineNum">     391</span> <span class="tlaUNC">           0 :     if (range == NULL){</span></span>
<span id="L392"><span class="lineNum">     392</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L393"><span class="lineNum">     393</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L394"><span class="lineNum">     394</span>              :     }</span>
<span id="L395"><span class="lineNum">     395</span>              : </span>
<span id="L396"><span class="lineNum">     396</span> <span class="tlaUNC">           0 :     WP = cos_array_from_floats(pdev, pcs-&gt;params.lab.WhitePoint, 3,</span></span>
<span id="L397"><span class="lineNum">     397</span>              :                                              &quot;write_lab_color_space&quot;);</span>
<span id="L398"><span class="lineNum">     398</span> <span class="tlaUNC">           0 :     if (WP == NULL) {</span></span>
<span id="L399"><span class="lineNum">     399</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L400"><span class="lineNum">     400</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)range, &quot;write_lab_color_space&quot;);</span></span>
<span id="L401"><span class="lineNum">     401</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L402"><span class="lineNum">     402</span>              :     }</span>
<span id="L403"><span class="lineNum">     403</span> <span class="tlaUNC">           0 :     BP = cos_array_from_floats(pdev, pcs-&gt;params.lab.BlackPoint, 3,</span></span>
<span id="L404"><span class="lineNum">     404</span>              :                                              &quot;write_lab_color_space&quot;);</span>
<span id="L405"><span class="lineNum">     405</span> <span class="tlaUNC">           0 :     if (BP == NULL) {</span></span>
<span id="L406"><span class="lineNum">     406</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L407"><span class="lineNum">     407</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)range, &quot;write_lab_color_space&quot;);</span></span>
<span id="L408"><span class="lineNum">     408</span> <span class="tlaUNC">           0 :         cos_free((cos_object_t *)WP, &quot;write_lab_color_space&quot;);</span></span>
<span id="L409"><span class="lineNum">     409</span> <span class="tlaUNC">           0 :         return_error(gs_error_VMerror);</span></span>
<span id="L410"><span class="lineNum">     410</span>              :     }</span>
<span id="L411"><span class="lineNum">     411</span>              : </span>
<span id="L412"><span class="lineNum">     412</span> <span class="tlaUNC">           0 :     for (i = 0;i &lt; 4;i++) {</span></span>
<span id="L413"><span class="lineNum">     413</span> <span class="tlaUNC">           0 :         code = cos_array_add_real(range, pcs-&gt;params.lab.Range[i]);</span></span>
<span id="L414"><span class="lineNum">     414</span> <span class="tlaUNC">           0 :         if (code &lt; 0)</span></span>
<span id="L415"><span class="lineNum">     415</span> <span class="tlaUNC">           0 :             goto error;</span></span>
<span id="L416"><span class="lineNum">     416</span>              :     }</span>
<span id="L417"><span class="lineNum">     417</span>              : </span>
<span id="L418"><span class="lineNum">     418</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/BlackPoint&quot;, COS_OBJECT_VALUE(&amp;v, BP));</span></span>
<span id="L419"><span class="lineNum">     419</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L420"><span class="lineNum">     420</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L421"><span class="lineNum">     421</span>              : </span>
<span id="L422"><span class="lineNum">     422</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/WhitePoint&quot;,  COS_OBJECT_VALUE(&amp;v, WP));</span></span>
<span id="L423"><span class="lineNum">     423</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L424"><span class="lineNum">     424</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L425"><span class="lineNum">     425</span>              : </span>
<span id="L426"><span class="lineNum">     426</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key(pcd, &quot;/Range&quot;,  COS_OBJECT_VALUE(&amp;v, range));</span></span>
<span id="L427"><span class="lineNum">     427</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L428"><span class="lineNum">     428</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L429"><span class="lineNum">     429</span>              : </span>
<span id="L430"><span class="lineNum">     430</span> <span class="tlaUNC">           0 :     code = cos_array_add_c_string(pca, &quot;/Lab&quot;);</span></span>
<span id="L431"><span class="lineNum">     431</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L432"><span class="lineNum">     432</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L433"><span class="lineNum">     433</span>              : </span>
<span id="L434"><span class="lineNum">     434</span> <span class="tlaUNC">           0 :     code = cos_array_add(pca,  COS_OBJECT_VALUE(&amp;v, pcd));</span></span>
<span id="L435"><span class="lineNum">     435</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L436"><span class="lineNum">     436</span> <span class="tlaUNC">           0 :         goto error;</span></span>
<span id="L437"><span class="lineNum">     437</span>              : </span>
<span id="L438"><span class="lineNum">     438</span>              :     return 0;</span>
<span id="L439"><span class="lineNum">     439</span>              : </span>
<span id="L440"><span class="lineNum">     440</span> <span class="tlaUNC">           0 : error:</span></span>
<span id="L441"><span class="lineNum">     441</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)pcd, &quot;write_calgray_color_space&quot;);</span></span>
<span id="L442"><span class="lineNum">     442</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)range, &quot;write_lab_color_space&quot;);</span></span>
<span id="L443"><span class="lineNum">     443</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)WP, &quot;write_lab_color_space&quot;);</span></span>
<span id="L444"><span class="lineNum">     444</span> <span class="tlaUNC">           0 :     cos_free((cos_object_t *)BP, &quot;write_lab_color_space&quot;);</span></span>
<span id="L445"><span class="lineNum">     445</span> <span class="tlaUNC">           0 :     return code;</span></span>
<span id="L446"><span class="lineNum">     446</span>              : }</span>
<span id="L447"><span class="lineNum">     447</span>              : </span>
<span id="L448"><span class="lineNum">     448</span>              : /*</span>
<span id="L449"><span class="lineNum">     449</span>              :  * Create an ICCBased color space object (internal).  The client must write</span>
<span id="L450"><span class="lineNum">     450</span>              :  * the profile data on *ppcstrm.</span>
<span id="L451"><span class="lineNum">     451</span>              :  */</span>
<span id="L452"><span class="lineNum">     452</span>              : static int</span>
<span id="L453"><span class="lineNum">     453</span> <span class="tlaUNC">           0 : pdf_make_iccbased(gx_device_pdf *pdev, const gs_gstate * pgs,</span></span>
<span id="L454"><span class="lineNum">     454</span>              :                   cos_array_t *pca, int ncomps,</span>
<span id="L455"><span class="lineNum">     455</span>              :                   const gs_range *prange /*[4]*/,</span>
<span id="L456"><span class="lineNum">     456</span>              :                   const gs_color_space *pcs,</span>
<span id="L457"><span class="lineNum">     457</span>              :                   cos_stream_t **ppcstrm,</span>
<span id="L458"><span class="lineNum">     458</span>              :                   const gs_range_t **pprange /* if scaling is needed */)</span>
<span id="L459"><span class="lineNum">     459</span>              : </span>
<span id="L460"><span class="lineNum">     460</span>              : {</span>
<span id="L461"><span class="lineNum">     461</span> <span class="tlaUNC">           0 :     cos_value_t v;</span></span>
<span id="L462"><span class="lineNum">     462</span> <span class="tlaUNC">           0 :     int code;</span></span>
<span id="L463"><span class="lineNum">     463</span> <span class="tlaUNC">           0 :     cos_stream_t * pcstrm = 0;</span></span>
<span id="L464"><span class="lineNum">     464</span> <span class="tlaUNC">           0 :     cos_array_t * prngca = 0;</span></span>
<span id="L465"><span class="lineNum">     465</span>              : </span>
<span id="L466"><span class="lineNum">     466</span>              :     /* Range values are a bit tricky to check.</span>
<span id="L467"><span class="lineNum">     467</span>              :        For example, CIELAB ICC profiles have</span>
<span id="L468"><span class="lineNum">     468</span>              :        a unique range.  I am not convinced</span>
<span id="L469"><span class="lineNum">     469</span>              :        that a check is needed in the new</span>
<span id="L470"><span class="lineNum">     470</span>              :        color architecture as I am carefull</span>
<span id="L471"><span class="lineNum">     471</span>              :        to get them properly set during</span>
<span id="L472"><span class="lineNum">     472</span>              :        creation of the ICC profile data. */</span>
<span id="L473"><span class="lineNum">     473</span>              : </span>
<span id="L474"><span class="lineNum">     474</span>              :     /* ICCBased color spaces are essentially copied to the output. */</span>
<span id="L475"><span class="lineNum">     475</span> <span class="tlaUNC">           0 :     if ((code = cos_array_add(pca, cos_c_string_value(&amp;v, &quot;/ICCBased&quot;))) &lt; 0)</span></span>
<span id="L476"><span class="lineNum">     476</span>              :         return code;</span>
<span id="L477"><span class="lineNum">     477</span>              : </span>
<span id="L478"><span class="lineNum">     478</span>              :     /* Create a stream for the output. */</span>
<span id="L479"><span class="lineNum">     479</span> <span class="tlaUNC">           0 :     if ((pcstrm = cos_stream_alloc(pdev, &quot;pdf_make_iccbased(stream)&quot;)) == 0) {</span></span>
<span id="L480"><span class="lineNum">     480</span> <span class="tlaUNC">           0 :         code = gs_note_error(gs_error_VMerror);</span></span>
<span id="L481"><span class="lineNum">     481</span> <span class="tlaUNC">           0 :         goto fail;</span></span>
<span id="L482"><span class="lineNum">     482</span>              :     }</span>
<span id="L483"><span class="lineNum">     483</span>              : </span>
<span id="L484"><span class="lineNum">     484</span>              :     /* Indicate the number of components. */</span>
<span id="L485"><span class="lineNum">     485</span> <span class="tlaUNC">           0 :     code = cos_dict_put_c_key_int(cos_stream_dict(pcstrm), &quot;/N&quot;, ncomps);</span></span>
<span id="L486"><span class="lineNum">     486</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L487"><span class="lineNum">     487</span> <span class="tlaUNC">           0 :         goto fail;</span></span>
<span id="L488"><span class="lineNum">     488</span>              : </span>
<span id="L489"><span class="lineNum">     489</span>              :     /* In the new design there may not be a specified alternate color space */</span>
<span id="L490"><span class="lineNum">     490</span> <span class="tlaUNC">           0 :     if (pcs-&gt;base_space != NULL){</span></span>
<span id="L491"><span class="lineNum">     491</span>              : </span>
<span id="L492"><span class="lineNum">     492</span>              :         /* Output the alternate color space, if necessary. */</span>
<span id="L493"><span class="lineNum">     493</span> <span class="tlaUNC">           0 :         switch (gs_color_space_get_index(pcs-&gt;base_space)) {</span></span>
<span id="L494"><span class="lineNum">     494</span>              :         case gs_color_space_index_DeviceGray:</span>
<span id="L495"><span class="lineNum">     495</span>              :         case gs_color_space_index_DeviceRGB:</span>
<span id="L496"><span class="lineNum">     496</span>              :         case gs_color_space_index_DeviceCMYK:</span>
<span id="L497"><span class="lineNum">     497</span>              :             break;                      /* implicit (default) */</span>
<span id="L498"><span class="lineNum">     498</span> <span class="tlaUNC">           0 :         default:</span></span>
<span id="L499"><span class="lineNum">     499</span> <span class="tlaUNC">           0 :             if ((code = pdf_color_space_named(pdev, pgs, &amp;v, NULL, pcs-&gt;base_space,</span></span>
<span id="L500"><span class="lineNum">     500</span> <span class="tlaUNC">           0 :                                         &amp;pdf_color_space_names, false, NULL, 0, true)) &lt; 0 ||</span></span>
<span id="L501"><span class="lineNum">     501</span> <span class="tlaUNC">           0 :                 (code = cos_dict_put_c_key(cos_stream_dict(pcstrm), &quot;/Alternate&quot;,</span></span>
<span id="L502"><span class="lineNum">     502</span>              :                                            &amp;v)) &lt; 0</span>
<span id="L503"><span class="lineNum">     503</span>              :                 )</span>
<span id="L504"><span class="lineNum">     504</span> <span class="tlaUNC">           0 :                 goto fail;</span></span>
<span id="L505"><span class="lineNum">     505</span>              :         }</span>
<span id="L506"><span class="lineNum">     506</span>              : </span>
<span id="L507"><span class="lineNum">     507</span>              :     } else {</span>
<span id="L508"><span class="lineNum">     508</span> <span class="tlaUNC">           0 :         cos_value_t alt_v;</span></span>
<span id="L509"><span class="lineNum">     509</span>              : </span>
<span id="L510"><span class="lineNum">     510</span> <span class="tlaUNC">           0 :         if (pcs-&gt;ICC_Alternate_space != gs_ICC_Alternate_None) {</span></span>
<span id="L511"><span class="lineNum">     511</span> <span class="tlaUNC">           0 :             switch(pcs-&gt;ICC_Alternate_space) {</span></span>
<span id="L512"><span class="lineNum">     512</span> <span class="tlaUNC">           0 :                 case gs_ICC_Alternate_DeviceGray:</span></span>
<span id="L513"><span class="lineNum">     513</span> <span class="tlaUNC">           0 :                     cos_c_string_value(&amp;alt_v, base_names.DeviceGray);</span></span>
<span id="L514"><span class="lineNum">     514</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L515"><span class="lineNum">     515</span> <span class="tlaUNC">           0 :                 case gs_ICC_Alternate_DeviceRGB:</span></span>
<span id="L516"><span class="lineNum">     516</span> <span class="tlaUNC">           0 :                     cos_c_string_value(&amp;alt_v, base_names.DeviceRGB);</span></span>
<span id="L517"><span class="lineNum">     517</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L518"><span class="lineNum">     518</span> <span class="tlaUNC">           0 :                 case gs_ICC_Alternate_DeviceCMYK:</span></span>
<span id="L519"><span class="lineNum">     519</span> <span class="tlaUNC">           0 :                     cos_c_string_value(&amp;alt_v, base_names.DeviceCMYK);</span></span>
<span id="L520"><span class="lineNum">     520</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L521"><span class="lineNum">     521</span> <span class="tlaUNC">           0 :                 case gs_ICC_Alternate_CalGray:</span></span>
<span id="L522"><span class="lineNum">     522</span>              :                     {</span>
<span id="L523"><span class="lineNum">     523</span> <span class="tlaUNC">           0 :                         pdf_resource_t *pres;</span></span>
<span id="L524"><span class="lineNum">     524</span> <span class="tlaUNC">           0 :                         cos_array_t *pca1;</span></span>
<span id="L525"><span class="lineNum">     525</span>              : </span>
<span id="L526"><span class="lineNum">     526</span> <span class="tlaUNC">           0 :                         code = pdf_alloc_resource(pdev, resourceColorSpace, gs_no_id, &amp;pres, -1);</span></span>
<span id="L527"><span class="lineNum">     527</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L528"><span class="lineNum">     528</span> <span class="tlaUNC">           0 :                             goto fail;</span></span>
<span id="L529"><span class="lineNum">     529</span> <span class="tlaUNC">           0 :                         cos_become(pres-&gt;object, cos_type_array);</span></span>
<span id="L530"><span class="lineNum">     530</span> <span class="tlaUNC">           0 :                         pca1 = (cos_array_t *)pres-&gt;object;</span></span>
<span id="L531"><span class="lineNum">     531</span>              : </span>
<span id="L532"><span class="lineNum">     532</span> <span class="tlaUNC">           0 :                         code = put_calgray_color_space(pdev, pgs, pcs, pca1);</span></span>
<span id="L533"><span class="lineNum">     533</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L534"><span class="lineNum">     534</span> <span class="tlaUNC">           0 :                             goto fail;</span></span>
<span id="L535"><span class="lineNum">     535</span>              : </span>
<span id="L536"><span class="lineNum">     536</span> <span class="tlaUNC">           0 :                         code = pdf_substitute_resource(pdev, &amp;pres, resourcePattern, NULL, false);</span></span>
<span id="L537"><span class="lineNum">     537</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L538"><span class="lineNum">     538</span> <span class="tlaUNC">           0 :                             return code;</span></span>
<span id="L539"><span class="lineNum">     539</span> <span class="tlaUNC">           0 :                         pres-&gt;where_used |= pdev-&gt;used_mask;</span></span>
<span id="L540"><span class="lineNum">     540</span> <span class="tlaUNC">           0 :                         cos_object_value(&amp;alt_v, pres-&gt;object);</span></span>
<span id="L541"><span class="lineNum">     541</span>              :                     }</span>
<span id="L542"><span class="lineNum">     542</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L543"><span class="lineNum">     543</span> <span class="tlaUNC">           0 :                 case gs_ICC_Alternate_CalRGB:</span></span>
<span id="L544"><span class="lineNum">     544</span>              :                     {</span>
<span id="L545"><span class="lineNum">     545</span> <span class="tlaUNC">           0 :                         pdf_resource_t *pres;</span></span>
<span id="L546"><span class="lineNum">     546</span> <span class="tlaUNC">           0 :                         cos_array_t *pca1;</span></span>
<span id="L547"><span class="lineNum">     547</span>              : </span>
<span id="L548"><span class="lineNum">     548</span> <span class="tlaUNC">           0 :                         code = pdf_alloc_resource(pdev, resourceColorSpace, gs_no_id, &amp;pres, -1);</span></span>
<span id="L549"><span class="lineNum">     549</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L550"><span class="lineNum">     550</span> <span class="tlaUNC">           0 :                             goto fail;</span></span>
<span id="L551"><span class="lineNum">     551</span> <span class="tlaUNC">           0 :                         cos_become(pres-&gt;object, cos_type_array);</span></span>
<span id="L552"><span class="lineNum">     552</span> <span class="tlaUNC">           0 :                         pca1 = (cos_array_t *)pres-&gt;object;</span></span>
<span id="L553"><span class="lineNum">     553</span>              : </span>
<span id="L554"><span class="lineNum">     554</span> <span class="tlaUNC">           0 :                         code = put_calrgb_color_space(pdev, pgs, pcs, pca1);</span></span>
<span id="L555"><span class="lineNum">     555</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L556"><span class="lineNum">     556</span> <span class="tlaUNC">           0 :                             goto fail;</span></span>
<span id="L557"><span class="lineNum">     557</span>              : </span>
<span id="L558"><span class="lineNum">     558</span> <span class="tlaUNC">           0 :                         code = pdf_substitute_resource(pdev, &amp;pres, resourceColorSpace, NULL, false);</span></span>
<span id="L559"><span class="lineNum">     559</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L560"><span class="lineNum">     560</span> <span class="tlaUNC">           0 :                             return code;</span></span>
<span id="L561"><span class="lineNum">     561</span> <span class="tlaUNC">           0 :                         pres-&gt;where_used |= pdev-&gt;used_mask;</span></span>
<span id="L562"><span class="lineNum">     562</span> <span class="tlaUNC">           0 :                         cos_object_value(&amp;alt_v, pres-&gt;object);</span></span>
<span id="L563"><span class="lineNum">     563</span>              :                     }</span>
<span id="L564"><span class="lineNum">     564</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L565"><span class="lineNum">     565</span> <span class="tlaUNC">           0 :                 case gs_ICC_Alternate_Lab:</span></span>
<span id="L566"><span class="lineNum">     566</span>              :                     {</span>
<span id="L567"><span class="lineNum">     567</span> <span class="tlaUNC">           0 :                         pdf_resource_t *pres;</span></span>
<span id="L568"><span class="lineNum">     568</span> <span class="tlaUNC">           0 :                         cos_array_t *pca1;</span></span>
<span id="L569"><span class="lineNum">     569</span>              : </span>
<span id="L570"><span class="lineNum">     570</span> <span class="tlaUNC">           0 :                         code = pdf_alloc_resource(pdev, resourceColorSpace, gs_no_id, &amp;pres, -1);</span></span>
<span id="L571"><span class="lineNum">     571</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L572"><span class="lineNum">     572</span> <span class="tlaUNC">           0 :                             goto fail;</span></span>
<span id="L573"><span class="lineNum">     573</span> <span class="tlaUNC">           0 :                         cos_become(pres-&gt;object, cos_type_array);</span></span>
<span id="L574"><span class="lineNum">     574</span> <span class="tlaUNC">           0 :                         pca1 = (cos_array_t *)pres-&gt;object;</span></span>
<span id="L575"><span class="lineNum">     575</span>              : </span>
<span id="L576"><span class="lineNum">     576</span> <span class="tlaUNC">           0 :                         code = put_lab_color_space(pdev, pgs, pcs, pca1);</span></span>
<span id="L577"><span class="lineNum">     577</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L578"><span class="lineNum">     578</span> <span class="tlaUNC">           0 :                             goto fail;</span></span>
<span id="L579"><span class="lineNum">     579</span>              : </span>
<span id="L580"><span class="lineNum">     580</span> <span class="tlaUNC">           0 :                         code = pdf_substitute_resource(pdev, &amp;pres, resourceColorSpace, NULL, false);</span></span>
<span id="L581"><span class="lineNum">     581</span> <span class="tlaUNC">           0 :                         if (code &lt; 0)</span></span>
<span id="L582"><span class="lineNum">     582</span> <span class="tlaUNC">           0 :                             return code;</span></span>
<span id="L583"><span class="lineNum">     583</span> <span class="tlaUNC">           0 :                         pres-&gt;where_used |= pdev-&gt;used_mask;</span></span>
<span id="L584"><span class="lineNum">     584</span> <span class="tlaUNC">           0 :                         cos_object_value(&amp;alt_v, pres-&gt;object);</span></span>
<span id="L585"><span class="lineNum">     585</span>              :                     }</span>
<span id="L586"><span class="lineNum">     586</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L587"><span class="lineNum">     587</span> <span class="tlaUNC">           0 :                 default:</span></span>
<span id="L588"><span class="lineNum">     588</span> <span class="tlaUNC">           0 :                     code = gs_error_rangecheck;</span></span>
<span id="L589"><span class="lineNum">     589</span> <span class="tlaUNC">           0 :                     goto fail;</span></span>
<span id="L590"><span class="lineNum">     590</span> <span class="tlaUNC">           0 :                     break;</span></span>
<span id="L591"><span class="lineNum">     591</span>              :             }</span>
<span id="L592"><span class="lineNum">     592</span> <span class="tlaUNC">           0 :             code = cos_dict_put_c_key(cos_stream_dict(pcstrm), &quot;/Alternate&quot;, &amp;alt_v);</span></span>
<span id="L593"><span class="lineNum">     593</span> <span class="tlaUNC">           0 :             if (code &lt; 0)</span></span>
<span id="L594"><span class="lineNum">     594</span> <span class="tlaUNC">           0 :                 goto fail;</span></span>
<span id="L595"><span class="lineNum">     595</span>              :         } else {</span>
<span id="L596"><span class="lineNum">     596</span> <span class="tlaUNC">           0 :             if (ncomps != 1 &amp;&amp; ncomps != 3 &amp;&amp; ncomps != 4) {</span></span>
<span id="L597"><span class="lineNum">     597</span>              :                 /* We can only use a default for Gray, RGB or CMYK. For anything else we need</span>
<span id="L598"><span class="lineNum">     598</span>              :                  * to convert to the base space, we can't legally preserve the ICC profile.</span>
<span id="L599"><span class="lineNum">     599</span>              :                  */</span>
<span id="L600"><span class="lineNum">     600</span> <span class="tlaUNC">           0 :                 code = gs_error_rangecheck;</span></span>
<span id="L601"><span class="lineNum">     601</span> <span class="tlaUNC">           0 :                 goto fail;</span></span>
<span id="L602"><span class="lineNum">     602</span>              :             }</span>
<span id="L603"><span class="lineNum">     603</span>              :         }</span>
<span id="L604"><span class="lineNum">     604</span>              :     }</span>
<span id="L605"><span class="lineNum">     605</span>              : </span>
<span id="L606"><span class="lineNum">     606</span>              :     /* Wrap up. */</span>
<span id="L607"><span class="lineNum">     607</span> <span class="tlaUNC">           0 :     if ((code = cos_array_add_object(pca, COS_OBJECT(pcstrm))) &lt; 0)</span></span>
<span id="L608"><span class="lineNum">     608</span> <span class="tlaUNC">           0 :         goto fail;</span></span>
<span id="L609"><span class="lineNum">     609</span> <span class="tlaUNC">           0 :     *ppcstrm = pcstrm;</span></span>
<span id="L610"><span class="lineNum">     610</span> <span class="tlaUNC">           0 :     return code;</span></span>
<span id="L611"><span class="lineNum">     611</span> <span class="tlaUNC">           0 :  fail:</span></span>
<span id="L612"><span class="lineNum">     612</span> <span class="tlaUNC">           0 :     if (prngca)</span></span>
<span id="L613"><span class="lineNum">     613</span>              :         COS_FREE(prngca, &quot;pdf_make_iccbased(Range)&quot;);</span>
<span id="L614"><span class="lineNum">     614</span> <span class="tlaUNC">           0 :     if (pcstrm)</span></span>
<span id="L615"><span class="lineNum">     615</span> <span class="tlaUNC">           0 :         COS_FREE(pcstrm, &quot;pdf_make_iccbased(stream)&quot;);</span></span>
<span id="L616"><span class="lineNum">     616</span>              :     return code;</span>
<span id="L617"><span class="lineNum">     617</span>              : }</span>
<span id="L618"><span class="lineNum">     618</span>              : /*</span>
<span id="L619"><span class="lineNum">     619</span>              :  * Finish writing the data stream for an ICCBased color space object.</span>
<span id="L620"><span class="lineNum">     620</span>              :  */</span>
<span id="L621"><span class="lineNum">     621</span>              : static int</span>
<span id="L622"><span class="lineNum">     622</span> <span class="tlaUNC">           0 : pdf_finish_iccbased(gx_device_pdf *pdev, cos_stream_t *pcstrm)</span></span>
<span id="L623"><span class="lineNum">     623</span>              : {</span>
<span id="L624"><span class="lineNum">     624</span>              :     /*</span>
<span id="L625"><span class="lineNum">     625</span>              :      * The stream must be an indirect object.  Assign an ID, and write the</span>
<span id="L626"><span class="lineNum">     626</span>              :      * object out now.</span>
<span id="L627"><span class="lineNum">     627</span>              :      */</span>
<span id="L628"><span class="lineNum">     628</span> <span class="tlaUNC">           0 :     pcstrm-&gt;id = pdf_obj_ref(pdev);</span></span>
<span id="L629"><span class="lineNum">     629</span> <span class="tlaUNC">           0 :     return cos_write_object(COS_OBJECT(pcstrm), pdev, resourceICC);</span></span>
<span id="L630"><span class="lineNum">     630</span>              : }</span>
<span id="L631"><span class="lineNum">     631</span>              : </span>
<span id="L632"><span class="lineNum">     632</span>              : /*</span>
<span id="L633"><span class="lineNum">     633</span>              :  * Create an ICCBased color space for a CIEBased space that can't be</span>
<span id="L634"><span class="lineNum">     634</span>              :  * represented directly as a Calxxx or Lab space.</span>
<span id="L635"><span class="lineNum">     635</span>              :  */</span>
<span id="L636"><span class="lineNum">     636</span>              : </span>
<span id="L637"><span class="lineNum">     637</span>              : typedef struct profile_table_s profile_table_t;</span>
<span id="L638"><span class="lineNum">     638</span>              : struct profile_table_s {</span>
<span id="L639"><span class="lineNum">     639</span>              :     const char *tag;</span>
<span id="L640"><span class="lineNum">     640</span>              :     const byte *data;</span>
<span id="L641"><span class="lineNum">     641</span>              :     uint length;</span>
<span id="L642"><span class="lineNum">     642</span>              :     uint data_length;           /* may be &lt; length if write != 0 */</span>
<span id="L643"><span class="lineNum">     643</span>              :     int (*write)(gx_device_pdf *pdev, cos_stream_t *, const profile_table_t *, gs_memory_t *,</span>
<span id="L644"><span class="lineNum">     644</span>              :                  const gs_cie_common *pciec);</span>
<span id="L645"><span class="lineNum">     645</span>              :     const void *write_data;</span>
<span id="L646"><span class="lineNum">     646</span>              :     const gs_range_t *ranges;</span>
<span id="L647"><span class="lineNum">     647</span>              : };</span>
<span id="L648"><span class="lineNum">     648</span>              : static profile_table_t *</span>
<span id="L649"><span class="lineNum">     649</span> <span class="tlaUNC">           0 : add_table(profile_table_t **ppnt, const char *tag, const byte *data,</span></span>
<span id="L650"><span class="lineNum">     650</span>              :           uint length)</span>
<span id="L651"><span class="lineNum">     651</span>              : {</span>
<span id="L652"><span class="lineNum">     652</span> <span class="tlaUNC">           0 :     profile_table_t *pnt = (*ppnt)++;</span></span>
<span id="L653"><span class="lineNum">     653</span>              : </span>
<span id="L654"><span class="lineNum">     654</span> <span class="tlaUNC">           0 :     pnt-&gt;tag = tag, pnt-&gt;data = data, pnt-&gt;length = length;</span></span>
<span id="L655"><span class="lineNum">     655</span> <span class="tlaUNC">           0 :     pnt-&gt;data_length = length;</span></span>
<span id="L656"><span class="lineNum">     656</span> <span class="tlaUNC">           0 :     pnt-&gt;write = NULL;</span></span>
<span id="L657"><span class="lineNum">     657</span>              :     /* write_data not set */</span>
<span id="L658"><span class="lineNum">     658</span> <span class="tlaUNC">           0 :     pnt-&gt;ranges = NULL;</span></span>
<span id="L659"><span class="lineNum">     659</span> <span class="tlaUNC">           0 :     return pnt;</span></span>
<span id="L660"><span class="lineNum">     660</span>              : }</span>
<span id="L661"><span class="lineNum">     661</span>              : static void</span>
<span id="L662"><span class="lineNum">     662</span> <span class="tlaUNC">           0 : set_uint32(byte bytes[4], uint value)</span></span>
<span id="L663"><span class="lineNum">     663</span>              : {</span>
<span id="L664"><span class="lineNum">     664</span> <span class="tlaUNC">           0 :     bytes[0] = (byte)(value &gt;&gt; 24);</span></span>
<span id="L665"><span class="lineNum">     665</span> <span class="tlaUNC">           0 :     bytes[1] = (byte)(value &gt;&gt; 16);</span></span>
<span id="L666"><span class="lineNum">     666</span> <span class="tlaUNC">           0 :     bytes[2] = (byte)(value &gt;&gt; 8);</span></span>
<span id="L667"><span class="lineNum">     667</span> <span class="tlaUNC">           0 :     bytes[3] = (byte)value;</span></span>
<span id="L668"><span class="lineNum">     668</span>              : }</span>
<span id="L669"><span class="lineNum">     669</span>              : static void</span>
<span id="L670"><span class="lineNum">     670</span> <span class="tlaUNC">           0 : set_XYZ(byte bytes[4], double value)</span></span>
<span id="L671"><span class="lineNum">     671</span>              : {</span>
<span id="L672"><span class="lineNum">     672</span> <span class="tlaUNC">           0 :     set_uint32(bytes, (uint)(int)(value * 65536));</span></span>
<span id="L673"><span class="lineNum">     673</span>              : }</span>
<span id="L674"><span class="lineNum">     674</span>              : static void</span>
<span id="L675"><span class="lineNum">     675</span> <span class="tlaUNC">           0 : add_table_xyz3(profile_table_t **ppnt, const char *tag, byte bytes[20],</span></span>
<span id="L676"><span class="lineNum">     676</span>              :                const gs_vector3 *pv)</span>
<span id="L677"><span class="lineNum">     677</span>              : {</span>
<span id="L678"><span class="lineNum">     678</span> <span class="tlaUNC">           0 :     memcpy(bytes, &quot;XYZ \000\000\000\000&quot;, 8);</span></span>
<span id="L679"><span class="lineNum">     679</span> <span class="tlaUNC">           0 :     set_XYZ(bytes + 8, pv-&gt;u);</span></span>
<span id="L680"><span class="lineNum">     680</span> <span class="tlaUNC">           0 :     set_XYZ(bytes + 12, pv-&gt;v);</span></span>
<span id="L681"><span class="lineNum">     681</span> <span class="tlaUNC">           0 :     set_XYZ(bytes + 16, pv-&gt;w);</span></span>
<span id="L682"><span class="lineNum">     682</span> <span class="tlaUNC">           0 :     DISCARD(add_table(ppnt, tag, bytes, 20));</span></span>
<span id="L683"><span class="lineNum">     683</span> <span class="tlaUNC">           0 : }</span></span>
<span id="L684"><span class="lineNum">     684</span>              : static void</span>
<span id="L685"><span class="lineNum">     685</span> <span class="tlaUNC">           0 : set_sample16(byte *p, double v)</span></span>
<span id="L686"><span class="lineNum">     686</span>              : {</span>
<span id="L687"><span class="lineNum">     687</span> <span class="tlaUNC">           0 :     int value = (int)(v * 65535);</span></span>
<span id="L688"><span class="lineNum">     688</span>              : </span>
<span id="L689"><span class="lineNum">     689</span> <span class="tlaUNC">           0 :     if (value &lt; 0)</span></span>
<span id="L690"><span class="lineNum">     690</span>              :         value = 0;</span>
<span id="L691"><span class="lineNum">     691</span> <span class="tlaUNC">           0 :     else if (value &gt; 65535)</span></span>
<span id="L692"><span class="lineNum">     692</span>              :         value = 65535;</span>
<span id="L693"><span class="lineNum">     693</span> <span class="tlaUNC">           0 :     p[0] = (byte)(value &gt;&gt; 8);</span></span>
<span id="L694"><span class="lineNum">     694</span> <span class="tlaUNC">           0 :     p[1] = (byte)value;</span></span>
<span id="L695"><span class="lineNum">     695</span>              : }</span>
<span id="L696"><span class="lineNum">     696</span>              : /* Create and write a TRC curve table. */</span>
<span id="L697"><span class="lineNum">     697</span>              : static int write_trc_abc(gx_device_pdf *pdev, cos_stream_t *, const profile_table_t *, gs_memory_t *, const gs_cie_common *);</span>
<span id="L698"><span class="lineNum">     698</span>              : static int write_trc_lmn(gx_device_pdf *pdev, cos_stream_t *, const profile_table_t *, gs_memory_t *, const gs_cie_common *);</span>
<span id="L699"><span class="lineNum">     699</span>              : static profile_table_t *</span>
<span id="L700"><span class="lineNum">     700</span> <span class="tlaUNC">           0 : add_trc(gx_device_pdf *pdev, profile_table_t **ppnt, const char *tag, byte bytes[12],</span></span>
<span id="L701"><span class="lineNum">     701</span>              :         const gs_cie_common *pciec, cie_cache_one_step_t one_step)</span>
<span id="L702"><span class="lineNum">     702</span>              : {</span>
<span id="L703"><span class="lineNum">     703</span> <span class="tlaUNC">           0 :     const int count = gx_cie_cache_size;</span></span>
<span id="L704"><span class="lineNum">     704</span> <span class="tlaUNC">           0 :     profile_table_t *pnt;</span></span>
<span id="L705"><span class="lineNum">     705</span>              : </span>
<span id="L706"><span class="lineNum">     706</span> <span class="tlaUNC">           0 :     memcpy(bytes, &quot;curv\000\000\000\000&quot;, 8);</span></span>
<span id="L707"><span class="lineNum">     707</span> <span class="tlaUNC">           0 :     set_uint32(bytes + 8, count);</span></span>
<span id="L708"><span class="lineNum">     708</span> <span class="tlaUNC">           0 :     pnt = add_table(ppnt, tag, bytes, 12);</span></span>
<span id="L709"><span class="lineNum">     709</span> <span class="tlaUNC">           0 :     pnt-&gt;length += count * 2;</span></span>
<span id="L710"><span class="lineNum">     710</span> <span class="tlaUNC">           0 :     pnt-&gt;write = (one_step == ONE_STEP_ABC ? write_trc_abc : write_trc_lmn);</span></span>
<span id="L711"><span class="lineNum">     711</span> <span class="tlaUNC">           0 :     pnt-&gt;write_data = (const gs_cie_abc *)pciec;</span></span>
<span id="L712"><span class="lineNum">     712</span> <span class="tlaUNC">           0 :     return pnt;</span></span>
<span id="L713"><span class="lineNum">     713</span>              : }</span>
<span id="L714"><span class="lineNum">     714</span>              : static int</span>
<span id="L715"><span class="lineNum">     715</span> <span class="tlaUNC">           0 : rgb_to_index(const profile_table_t *pnt)</span></span>
<span id="L716"><span class="lineNum">     716</span>              : {</span>
<span id="L717"><span class="lineNum">     717</span> <span class="tlaUNC">           0 :     switch (pnt-&gt;tag[0]) {</span></span>
<span id="L718"><span class="lineNum">     718</span>              :     case 'r': return 0;</span>
<span id="L719"><span class="lineNum">     719</span> <span class="tlaUNC">           0 :     case 'g': return 1;</span></span>
<span id="L720"><span class="lineNum">     720</span> <span class="tlaUNC">           0 :     case 'b': default: /* others can't happen */ return 2;</span></span>
<span id="L721"><span class="lineNum">     721</span>              :     }</span>
<span id="L722"><span class="lineNum">     722</span>              : }</span>
<span id="L723"><span class="lineNum">     723</span>              : static double</span>
<span id="L724"><span class="lineNum">     724</span> <span class="tlaUNC">           0 : cache_arg(int i, int denom, const gs_range_t *range)</span></span>
<span id="L725"><span class="lineNum">     725</span>              : {</span>
<span id="L726"><span class="lineNum">     726</span> <span class="tlaUNC">           0 :     double arg = i / (double)denom;</span></span>
<span id="L727"><span class="lineNum">     727</span>              : </span>
<span id="L728"><span class="lineNum">     728</span> <span class="tlaUNC">           0 :     if (range) {</span></span>
<span id="L729"><span class="lineNum">     729</span>              :         /* Sample over the range [range-&gt;rmin .. range-&gt;rmax]. */</span>
<span id="L730"><span class="lineNum">     730</span> <span class="tlaUNC">           0 :         arg = arg * (range-&gt;rmax - range-&gt;rmin) + range-&gt;rmin;</span></span>
<span id="L731"><span class="lineNum">     731</span>              :     }</span>
<span id="L732"><span class="lineNum">     732</span> <span class="tlaUNC">           0 :     return arg;</span></span>
<span id="L733"><span class="lineNum">     733</span>              : }</span>
<span id="L734"><span class="lineNum">     734</span>              : </span>
<span id="L735"><span class="lineNum">     735</span>              : static int</span>
<span id="L736"><span class="lineNum">     736</span> <span class="tlaUNC">           0 : write_trc_abc(gx_device_pdf *pdev, cos_stream_t *pcstrm, const profile_table_t *pnt,</span></span>
<span id="L737"><span class="lineNum">     737</span>              :               gs_memory_t *ignore_mem, const gs_cie_common *unused)</span>
<span id="L738"><span class="lineNum">     738</span>              : {</span>
<span id="L739"><span class="lineNum">     739</span>              :     /* Write the curve table from DecodeABC. */</span>
<span id="L740"><span class="lineNum">     740</span> <span class="tlaUNC">           0 :     const gs_cie_abc *pabc = pnt-&gt;write_data;</span></span>
<span id="L741"><span class="lineNum">     741</span> <span class="tlaUNC">           0 :     int ci = rgb_to_index(pnt);</span></span>
<span id="L742"><span class="lineNum">     742</span> <span class="tlaUNC">           0 :     gs_cie_abc_proc proc = pabc-&gt;DecodeABC.procs[ci];</span></span>
<span id="L743"><span class="lineNum">     743</span> <span class="tlaUNC">           0 :     byte samples[gx_cie_cache_size * 2];</span></span>
<span id="L744"><span class="lineNum">     744</span> <span class="tlaUNC">           0 :     byte *p = samples;</span></span>
<span id="L745"><span class="lineNum">     745</span> <span class="tlaUNC">           0 :     int i;</span></span>
<span id="L746"><span class="lineNum">     746</span>              : </span>
<span id="L747"><span class="lineNum">     747</span> <span class="tlaUNC">           0 :     for (i = 0; i &lt; gx_cie_cache_size; ++i, p += 2)</span></span>
<span id="L748"><span class="lineNum">     748</span> <span class="tlaUNC">           0 :         set_sample16(p, proc(cache_arg(i, gx_cie_cache_size - 1, pnt-&gt;ranges),</span></span>
<span id="L749"><span class="lineNum">     749</span>              :                              pabc));</span>
<span id="L750"><span class="lineNum">     750</span> <span class="tlaUNC">           0 :     return cos_stream_add_bytes(pdev, pcstrm, samples, gx_cie_cache_size * 2);</span></span>
<span id="L751"><span class="lineNum">     751</span>              : }</span>
<span id="L752"><span class="lineNum">     752</span>              : static int</span>
<span id="L753"><span class="lineNum">     753</span> <span class="tlaUNC">           0 : write_trc_lmn(gx_device_pdf *pdev, cos_stream_t *pcstrm, const profile_table_t *pnt,</span></span>
<span id="L754"><span class="lineNum">     754</span>              :               gs_memory_t *ignore_mem, const gs_cie_common *unused)</span>
<span id="L755"><span class="lineNum">     755</span>              : {</span>
<span id="L756"><span class="lineNum">     756</span> <span class="tlaUNC">           0 :     const gs_cie_common *pciec = pnt-&gt;write_data;</span></span>
<span id="L757"><span class="lineNum">     757</span> <span class="tlaUNC">           0 :     int ci = rgb_to_index(pnt);</span></span>
<span id="L758"><span class="lineNum">     758</span> <span class="tlaUNC">           0 :     gs_cie_common_proc proc = pciec-&gt;DecodeLMN.procs[ci];</span></span>
<span id="L759"><span class="lineNum">     759</span> <span class="tlaUNC">           0 :     byte samples[gx_cie_cache_size * 2];</span></span>
<span id="L760"><span class="lineNum">     760</span> <span class="tlaUNC">           0 :     byte *p = samples;</span></span>
<span id="L761"><span class="lineNum">     761</span> <span class="tlaUNC">           0 :     int i;</span></span>
<span id="L762"><span class="lineNum">     762</span>              : </span>
<span id="L763"><span class="lineNum">     763</span>              :     /* Write the curve table from DecodeLMN. */</span>
<span id="L764"><span class="lineNum">     764</span> <span class="tlaUNC">           0 :     for (i = 0; i &lt; gx_cie_cache_size; ++i, p += 2)</span></span>
<span id="L765"><span class="lineNum">     765</span> <span class="tlaUNC">           0 :         set_sample16(p, proc(cache_arg(i, gx_cie_cache_size - 1, pnt-&gt;ranges),</span></span>
<span id="L766"><span class="lineNum">     766</span>              :                              pciec));</span>
<span id="L767"><span class="lineNum">     767</span> <span class="tlaUNC">           0 :     return cos_stream_add_bytes(pdev, pcstrm, samples, gx_cie_cache_size * 2);</span></span>
<span id="L768"><span class="lineNum">     768</span>              : }</span>
<span id="L769"><span class="lineNum">     769</span>              : /* Create and write an a2b0 lookup table. */</span>
<span id="L770"><span class="lineNum">     770</span>              : #define NUM_IN_ENTRIES 2        /* assume linear interpolation */</span>
<span id="L771"><span class="lineNum">     771</span>              : #define NUM_OUT_ENTRIES 2       /* ibid. */</span>
<span id="L772"><span class="lineNum">     772</span>              : #define MAX_CLUT_ENTRIES 2500   /* enough for 7^4 */</span>
<span id="L773"><span class="lineNum">     773</span>              : typedef struct icc_a2b0_s {</span>
<span id="L774"><span class="lineNum">     774</span>              :     byte header[52];</span>
<span id="L775"><span class="lineNum">     775</span>              :     const gs_color_space *pcs;</span>
<span id="L776"><span class="lineNum">     776</span>              :     int num_points;             /* on each axis of LUT */</span>
<span id="L777"><span class="lineNum">     777</span>              :     int count;                  /* total # of entries in LUT */</span>
<span id="L778"><span class="lineNum">     778</span>              : } icc_a2b0_t;</span>
<span id="L779"><span class="lineNum">     779</span>              : static int write_a2b0(gx_device_pdf *pdev, cos_stream_t *, const profile_table_t *, gs_memory_t *,</span>
<span id="L780"><span class="lineNum">     780</span>              :                       const gs_cie_common *pciec);</span>
<span id="L781"><span class="lineNum">     781</span>              : static profile_table_t *</span>
<span id="L782"><span class="lineNum">     782</span> <span class="tlaUNC">           0 : add_a2b0(profile_table_t **ppnt, icc_a2b0_t *pa2b, int ncomps,</span></span>
<span id="L783"><span class="lineNum">     783</span>              :          const gs_color_space *pcs)</span>
<span id="L784"><span class="lineNum">     784</span>              : {</span>
<span id="L785"><span class="lineNum">     785</span> <span class="tlaUNC">           0 :     static const byte a2b0_data[sizeof(pa2b-&gt;header)] = {</span></span>
<span id="L786"><span class="lineNum">     786</span>              :         'm', 'f', 't', '2',             /* type signature */</span>
<span id="L787"><span class="lineNum">     787</span>              :         0, 0, 0, 0,                     /* reserved, 0 */</span>
<span id="L788"><span class="lineNum">     788</span>              :         0,                              /* # of input channels **VARIABLE** */</span>
<span id="L789"><span class="lineNum">     789</span>              :         3,                              /* # of output channels */</span>
<span id="L790"><span class="lineNum">     790</span>              :         0,                              /* # of CLUT points **VARIABLE** */</span>
<span id="L791"><span class="lineNum">     791</span>              :         0,                              /* reserved, padding */</span>
<span id="L792"><span class="lineNum">     792</span>              :         0, 1, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0, /* matrix column 0 */</span>
<span id="L793"><span class="lineNum">     793</span>              :         0, 0, 0, 0,  0, 1, 0, 0,  0, 0, 0, 0, /* matrix column 1 */</span>
<span id="L794"><span class="lineNum">     794</span>              :         0, 0, 0, 0,  0, 0, 0, 0,  0, 1, 0, 0, /* matrix column 2 */</span>
<span id="L795"><span class="lineNum">     795</span>              :         0, NUM_IN_ENTRIES,              /* # of input table entries */</span>
<span id="L796"><span class="lineNum">     796</span>              :         0, NUM_OUT_ENTRIES              /* # of output table entries */</span>
<span id="L797"><span class="lineNum">     797</span>              :     };</span>
<span id="L798"><span class="lineNum">     798</span> <span class="tlaUNC">           0 :     int num_points = (int)floor(pow(MAX_CLUT_ENTRIES, 1.0 / ncomps));</span></span>
<span id="L799"><span class="lineNum">     799</span> <span class="tlaUNC">           0 :     profile_table_t *pnt;</span></span>
<span id="L800"><span class="lineNum">     800</span>              : </span>
<span id="L801"><span class="lineNum">     801</span> <span class="tlaUNC">           0 :     num_points = min(num_points, 255);</span></span>
<span id="L802"><span class="lineNum">     802</span> <span class="tlaUNC">           0 :     memcpy(pa2b-&gt;header, a2b0_data, sizeof(a2b0_data));</span></span>
<span id="L803"><span class="lineNum">     803</span> <span class="tlaUNC">           0 :     pa2b-&gt;header[8] = ncomps;</span></span>
<span id="L804"><span class="lineNum">     804</span> <span class="tlaUNC">           0 :     pa2b-&gt;header[10] = num_points;</span></span>
<span id="L805"><span class="lineNum">     805</span> <span class="tlaUNC">           0 :     pa2b-&gt;pcs = pcs;</span></span>
<span id="L806"><span class="lineNum">     806</span> <span class="tlaUNC">           0 :     pa2b-&gt;num_points = num_points;</span></span>
<span id="L807"><span class="lineNum">     807</span> <span class="tlaUNC">           0 :     pa2b-&gt;count = (int)pow(num_points, ncomps);</span></span>
<span id="L808"><span class="lineNum">     808</span> <span class="tlaUNC">           0 :     pnt = add_table(ppnt, &quot;A2B0&quot;, pa2b-&gt;header,</span></span>
<span id="L809"><span class="lineNum">     809</span>              :                     sizeof(pa2b-&gt;header) +</span>
<span id="L810"><span class="lineNum">     810</span> <span class="tlaUNC">           0 :                     ncomps * 2 * NUM_IN_ENTRIES + /* in */</span></span>
<span id="L811"><span class="lineNum">     811</span> <span class="tlaUNC">           0 :                     pa2b-&gt;count * (3 * 2) + /* clut: XYZ, 16-bit values */</span></span>
<span id="L812"><span class="lineNum">     812</span>              :                     3 * 2 * NUM_OUT_ENTRIES /* out */</span>
<span id="L813"><span class="lineNum">     813</span>              :                     );</span>
<span id="L814"><span class="lineNum">     814</span> <span class="tlaUNC">           0 :     pnt-&gt;data_length = sizeof(pa2b-&gt;header); /* only write fixed part */</span></span>
<span id="L815"><span class="lineNum">     815</span> <span class="tlaUNC">           0 :     pnt-&gt;write = write_a2b0;</span></span>
<span id="L816"><span class="lineNum">     816</span> <span class="tlaUNC">           0 :     pnt-&gt;write_data = pa2b;</span></span>
<span id="L817"><span class="lineNum">     817</span> <span class="tlaUNC">           0 :     return pnt;</span></span>
<span id="L818"><span class="lineNum">     818</span>              : }</span>
<span id="L819"><span class="lineNum">     819</span>              : static int</span>
<span id="L820"><span class="lineNum">     820</span> <span class="tlaUNC">           0 : write_a2b0(gx_device_pdf *pdev, cos_stream_t *pcstrm, const profile_table_t *pnt,</span></span>
<span id="L821"><span class="lineNum">     821</span>              :            gs_memory_t *mem, const gs_cie_common *pciec)</span>
<span id="L822"><span class="lineNum">     822</span>              : {</span>
<span id="L823"><span class="lineNum">     823</span> <span class="tlaUNC">           0 :     const icc_a2b0_t *pa2b = pnt-&gt;write_data;</span></span>
<span id="L824"><span class="lineNum">     824</span> <span class="tlaUNC">           0 :     const gs_color_space *pcs = pa2b-&gt;pcs;</span></span>
<span id="L825"><span class="lineNum">     825</span> <span class="tlaUNC">           0 :     int ncomps = pa2b-&gt;header[8];</span></span>
<span id="L826"><span class="lineNum">     826</span> <span class="tlaUNC">           0 :     int num_points = pa2b-&gt;num_points;</span></span>
<span id="L827"><span class="lineNum">     827</span> <span class="tlaUNC">           0 :     int i;</span></span>
<span id="L828"><span class="lineNum">     828</span>              : #define MAX_NCOMPS 4            /* CIEBasedDEFG */</span>
<span id="L829"><span class="lineNum">     829</span> <span class="tlaUNC">           0 :     static const byte v01[MAX_NCOMPS * 2 * 2] = {</span></span>
<span id="L830"><span class="lineNum">     830</span>              :         0,0, 255,255,   0,0, 255,255,   0,0, 255,255,   0,0, 255,255</span>
<span id="L831"><span class="lineNum">     831</span>              :     };</span>
<span id="L832"><span class="lineNum">     832</span> <span class="tlaUNC">           0 :     gs_gstate *pgs;</span></span>
<span id="L833"><span class="lineNum">     833</span> <span class="tlaUNC">           0 :     int code;</span></span>
<span id="L834"><span class="lineNum">     834</span>              : </span>
<span id="L835"><span class="lineNum">     835</span>              :     /* Write the input table. */</span>
<span id="L836"><span class="lineNum">     836</span>              : </span>
<span id="L837"><span class="lineNum">     837</span> <span class="tlaUNC">           0 :     if ((code = cos_stream_add_bytes(pdev, pcstrm, v01, ncomps * 4)) &lt; 0</span></span>
<span id="L838"><span class="lineNum">     838</span>              :         )</span>
<span id="L839"><span class="lineNum">     839</span>              :         return code;</span>
<span id="L840"><span class="lineNum">     840</span>              : </span>
<span id="L841"><span class="lineNum">     841</span>              :     /* Write the lookup table. */</span>
<span id="L842"><span class="lineNum">     842</span>              : </span>
<span id="L843"><span class="lineNum">     843</span> <span class="tlaUNC">           0 :     code = gx_cie_to_xyz_alloc(&amp;pgs, pcs, mem);</span></span>
<span id="L844"><span class="lineNum">     844</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L845"><span class="lineNum">     845</span>              :         return code;</span>
<span id="L846"><span class="lineNum">     846</span> <span class="tlaUNC">           0 :     for (i = 0; i &lt; pa2b-&gt;count; ++i) {</span></span>
<span id="L847"><span class="lineNum">     847</span> <span class="tlaUNC">           0 :         double in[MAX_NCOMPS], xyz[3];</span></span>
<span id="L848"><span class="lineNum">     848</span> <span class="tlaUNC">           0 :         byte entry[3 * 2];</span></span>
<span id="L849"><span class="lineNum">     849</span> <span class="tlaUNC">           0 :         byte *p = entry;</span></span>
<span id="L850"><span class="lineNum">     850</span> <span class="tlaUNC">           0 :         int n, j;</span></span>
<span id="L851"><span class="lineNum">     851</span>              : </span>
<span id="L852"><span class="lineNum">     852</span> <span class="tlaUNC">           0 :         for (n = i, j = ncomps - 1; j &gt;= 0; --j, n /= num_points)</span></span>
<span id="L853"><span class="lineNum">     853</span> <span class="tlaUNC">           0 :             in[j] = cache_arg(n % num_points, num_points - 1,</span></span>
<span id="L854"><span class="lineNum">     854</span> <span class="tlaUNC">           0 :                               (pnt-&gt;ranges ? pnt-&gt;ranges + j : NULL));</span></span>
<span id="L855"><span class="lineNum">     855</span> <span class="tlaUNC">           0 :         cie_to_xyz(in, xyz, pcs, pgs, pciec);</span></span>
<span id="L856"><span class="lineNum">     856</span>              :         /*</span>
<span id="L857"><span class="lineNum">     857</span>              :          * NOTE: Due to an obscure provision of the ICC Profile</span>
<span id="L858"><span class="lineNum">     858</span>              :          * specification, values in a2b0 lookup tables do *not* represent</span>
<span id="L859"><span class="lineNum">     859</span>              :          * the range [0 .. 1], but rather the range [0</span>
<span id="L860"><span class="lineNum">     860</span>              :          * .. MAX_ICC_XYZ_VALUE].  This caused us a lot of grief before we</span>
<span id="L861"><span class="lineNum">     861</span>              :          * figured it out!</span>
<span id="L862"><span class="lineNum">     862</span>              :          */</span>
<span id="L863"><span class="lineNum">     863</span>              : #define MAX_ICC_XYZ_VALUE (1 + 32767.0/32768)</span>
<span id="L864"><span class="lineNum">     864</span> <span class="tlaUNC">           0 :         for (j = 0; j &lt; 3; ++j, p += 2)</span></span>
<span id="L865"><span class="lineNum">     865</span> <span class="tlaUNC">           0 :             set_sample16(p, xyz[j] / MAX_ICC_XYZ_VALUE);</span></span>
<span id="L866"><span class="lineNum">     866</span>              : #undef MAX_ICC_XYZ_VALUE</span>
<span id="L867"><span class="lineNum">     867</span> <span class="tlaUNC">           0 :         if ((code = cos_stream_add_bytes(pdev, pcstrm, entry, sizeof(entry))) &lt; 0)</span></span>
<span id="L868"><span class="lineNum">     868</span>              :             break;</span>
<span id="L869"><span class="lineNum">     869</span>              :     }</span>
<span id="L870"><span class="lineNum">     870</span> <span class="tlaUNC">           0 :     gx_cie_to_xyz_free(pgs);</span></span>
<span id="L871"><span class="lineNum">     871</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L872"><span class="lineNum">     872</span>              :         return code;</span>
<span id="L873"><span class="lineNum">     873</span>              : </span>
<span id="L874"><span class="lineNum">     874</span>              :     /* Write the output table. */</span>
<span id="L875"><span class="lineNum">     875</span>              : </span>
<span id="L876"><span class="lineNum">     876</span> <span class="tlaUNC">           0 :     return cos_stream_add_bytes(pdev, pcstrm, v01, 3 * 4);</span></span>
<span id="L877"><span class="lineNum">     877</span>              : }</span>
<span id="L878"><span class="lineNum">     878</span>              : </span>
<span id="L879"><span class="lineNum">     879</span>              : /* XYZ wp mapping for now.  Will replace later with Bradford or other */</span>
<span id="L880"><span class="lineNum">     880</span>              : static void</span>
<span id="L881"><span class="lineNum">     881</span> <span class="tlaUNC">           0 : adjust_wp(const gs_vector3 *color_in, const gs_vector3 *wp_in,</span></span>
<span id="L882"><span class="lineNum">     882</span>              :           gs_vector3 *color_out, const gs_vector3 *wp_out)</span>
<span id="L883"><span class="lineNum">     883</span>              : {</span>
<span id="L884"><span class="lineNum">     884</span> <span class="tlaUNC">           0 :     color_out-&gt;u = color_in-&gt;u * wp_out-&gt;u / wp_in-&gt;u;</span></span>
<span id="L885"><span class="lineNum">     885</span> <span class="tlaUNC">           0 :     color_out-&gt;v = color_in-&gt;v * wp_out-&gt;v / wp_in-&gt;v;</span></span>
<span id="L886"><span class="lineNum">     886</span> <span class="tlaUNC">           0 :     color_out-&gt;w = color_in-&gt;w * wp_out-&gt;w / wp_in-&gt;w;</span></span>
<span id="L887"><span class="lineNum">     887</span> <span class="tlaUNC">           0 : }</span></span>
<span id="L888"><span class="lineNum">     888</span>              : </span>
<span id="L889"><span class="lineNum">     889</span>              : static int</span>
<span id="L890"><span class="lineNum">     890</span> <span class="tlaUNC">           0 : pdf_convert_cie_to_iccbased(gx_device_pdf *pdev, cos_array_t *pca,</span></span>
<span id="L891"><span class="lineNum">     891</span>              :                             gs_color_space *pcs, const char *dcsname,</span>
<span id="L892"><span class="lineNum">     892</span>              :                             const gs_cie_common *pciec, const gs_range *prange,</span>
<span id="L893"><span class="lineNum">     893</span>              :                             cie_cache_one_step_t one_step,</span>
<span id="L894"><span class="lineNum">     894</span>              :                             const gs_matrix3 *pmat, const gs_range_t **pprange)</span>
<span id="L895"><span class="lineNum">     895</span>              : {</span>
<span id="L896"><span class="lineNum">     896</span>              :     /*</span>
<span id="L897"><span class="lineNum">     897</span>              :      * We have two options for creating an ICCBased color space to represent</span>
<span id="L898"><span class="lineNum">     898</span>              :      * a CIEBased space.  For CIEBasedABC spaces using only a single</span>
<span id="L899"><span class="lineNum">     899</span>              :      * Decode step followed by a single Matrix step, we can use [rgb]TRC</span>
<span id="L900"><span class="lineNum">     900</span>              :      * and [rgb]XYZ; for CIEBasedA spaces using only DecodeA, we could use</span>
<span id="L901"><span class="lineNum">     901</span>              :      * kTRC (but don't); otherwise, we must use a mft2 LUT.</span>
<span id="L902"><span class="lineNum">     902</span>              :      */</span>
<span id="L903"><span class="lineNum">     903</span> <span class="tlaUNC">           0 :     int code;</span></span>
<span id="L904"><span class="lineNum">     904</span> <span class="tlaUNC">           0 :     int ncomps = gs_color_space_num_components(pcs);</span></span>
<span id="L905"><span class="lineNum">     905</span> <span class="tlaUNC">           0 :     gs_color_space *alt_space;</span></span>
<span id="L906"><span class="lineNum">     906</span> <span class="tlaUNC">           0 :     cos_stream_t *pcstrm;</span></span>
<span id="L907"><span class="lineNum">     907</span> <span class="tlaUNC">           0 :     gs_vector3 white_d50;</span></span>
<span id="L908"><span class="lineNum">     908</span> <span class="tlaUNC">           0 :     gs_vector3 temp_xyz;</span></span>
<span id="L909"><span class="lineNum">     909</span>              :     /*</span>
<span id="L910"><span class="lineNum">     910</span>              :      * because it requires random access to the output stream</span>
<span id="L911"><span class="lineNum">     911</span>              :      * we construct the ICC profile by hand.</span>
<span id="L912"><span class="lineNum">     912</span>              :      */</span>
<span id="L913"><span class="lineNum">     913</span>              :     /* Header */</span>
<span id="L914"><span class="lineNum">     914</span> <span class="tlaUNC">           0 :     byte header[128];</span></span>
<span id="L915"><span class="lineNum">     915</span> <span class="tlaUNC">           0 :     static const byte header_data[] = {</span></span>
<span id="L916"><span class="lineNum">     916</span>              :         0, 0, 0, 0,                     /* profile size **VARIABLE** */</span>
<span id="L917"><span class="lineNum">     917</span>              :         0, 0, 0, 0,                     /* CMM type signature */</span>
<span id="L918"><span class="lineNum">     918</span>              :         0x02, 0x20, 0, 0,               /* profile version number */</span>
<span id="L919"><span class="lineNum">     919</span>              :         's', 'c', 'n', 'r',             /* profile class signature */</span>
<span id="L920"><span class="lineNum">     920</span>              :         0, 0, 0, 0,                     /* data color space **VARIABLE** */</span>
<span id="L921"><span class="lineNum">     921</span>              :         'X', 'Y', 'Z', ' ',             /* connection color space */</span>
<span id="L922"><span class="lineNum">     922</span>              :         2002 / 256, 2002 % 256, 0, 1, 0, 1, /* date (1/1/2002) */</span>
<span id="L923"><span class="lineNum">     923</span>              :         0, 0, 0, 0, 0, 0,               /* time */</span>
<span id="L924"><span class="lineNum">     924</span>              :         'a', 'c', 's', 'p',             /* profile file signature */</span>
<span id="L925"><span class="lineNum">     925</span>              :         0, 0, 0, 0,                     /* primary platform signature */</span>
<span id="L926"><span class="lineNum">     926</span>              :         0, 0, 0, 3,                     /* profile flags (embedded use only) */</span>
<span id="L927"><span class="lineNum">     927</span>              :         0, 0, 0, 0, 0, 0, 0, 0,         /* device manufacturer */</span>
<span id="L928"><span class="lineNum">     928</span>              :         0, 0, 0, 0,                     /* device model */</span>
<span id="L929"><span class="lineNum">     929</span>              :         0, 0, 0, 0, 0, 0, 0, 2          /* device attributes */</span>
<span id="L930"><span class="lineNum">     930</span>              :         /* Remaining fields are zero or variable. */</span>
<span id="L931"><span class="lineNum">     931</span>              :         /* [4] */                       /* rendering intent */</span>
<span id="L932"><span class="lineNum">     932</span>              :         /* 3 * [4] */                   /* illuminant */</span>
<span id="L933"><span class="lineNum">     933</span>              :     };</span>
<span id="L934"><span class="lineNum">     934</span>              :     /* Description */</span>
<span id="L935"><span class="lineNum">     935</span>              : #define DESC_LENGTH 5           /* &quot;adhoc&quot; */</span>
<span id="L936"><span class="lineNum">     936</span> <span class="tlaUNC">           0 :     byte desc[12 + DESC_LENGTH + 1 + 11 + 67];</span></span>
<span id="L937"><span class="lineNum">     937</span> <span class="tlaUNC">           0 :     static const byte desc_data[] = {</span></span>
<span id="L938"><span class="lineNum">     938</span>              :         'd', 'e', 's', 'c',             /* type signature */</span>
<span id="L939"><span class="lineNum">     939</span>              :         0, 0, 0, 0,                     /* reserved, 0 */</span>
<span id="L940"><span class="lineNum">     940</span>              :         0, 0, 0, DESC_LENGTH + 1,       /* ASCII description length */</span>
<span id="L941"><span class="lineNum">     941</span>              :         'a', 'd', 'h', 'o', 'c', 0,     /* ASCII description */</span>
<span id="L942"><span class="lineNum">     942</span>              :         /* Remaining fields are zero. */</span>
<span id="L943"><span class="lineNum">     943</span>              :     };</span>
<span id="L944"><span class="lineNum">     944</span>              :     /* White point */</span>
<span id="L945"><span class="lineNum">     945</span> <span class="tlaUNC">           0 :     byte wtpt[20];</span></span>
<span id="L946"><span class="lineNum">     946</span>              :     /* Copyright (useless, but required by icclib) */</span>
<span id="L947"><span class="lineNum">     947</span> <span class="tlaUNC">           0 :     static const byte cprt_data[] = {</span></span>
<span id="L948"><span class="lineNum">     948</span>              :         't', 'e', 'x', 't',     /* type signature */</span>
<span id="L949"><span class="lineNum">     949</span>              :         0, 0, 0, 0,             /* reserved, 0 */</span>
<span id="L950"><span class="lineNum">     950</span>              :         'n', 'o', 'n', 'e', 0   /* must be null-terminated (!) */</span>
<span id="L951"><span class="lineNum">     951</span>              :     };</span>
<span id="L952"><span class="lineNum">     952</span>              :     /* Lookup table */</span>
<span id="L953"><span class="lineNum">     953</span> <span class="tlaUNC">           0 :     icc_a2b0_t a2b0;</span></span>
<span id="L954"><span class="lineNum">     954</span>              :     /* [rgb]TRC */</span>
<span id="L955"><span class="lineNum">     955</span> <span class="tlaUNC">           0 :     byte rTRC[12], gTRC[12], bTRC[12];</span></span>
<span id="L956"><span class="lineNum">     956</span>              :     /* [rgb]XYZ */</span>
<span id="L957"><span class="lineNum">     957</span> <span class="tlaUNC">           0 :     byte rXYZ[20], gXYZ[20], bXYZ[20];</span></span>
<span id="L958"><span class="lineNum">     958</span>              :     /* Table structures */</span>
<span id="L959"><span class="lineNum">     959</span>              : #define MAX_NUM_TABLES 9        /* desc, [rgb]TRC, [rgb]xYZ, wtpt, cprt */</span>
<span id="L960"><span class="lineNum">     960</span> <span class="tlaUNC">           0 :     profile_table_t tables[MAX_NUM_TABLES];</span></span>
<span id="L961"><span class="lineNum">     961</span> <span class="tlaUNC">           0 :     profile_table_t *next_table = tables;</span></span>
<span id="L962"><span class="lineNum">     962</span>              : </span>
<span id="L963"><span class="lineNum">     963</span>              :     /* White point must be D50 */</span>
<span id="L964"><span class="lineNum">     964</span> <span class="tlaUNC">           0 :     white_d50.u = 0.9642f;</span></span>
<span id="L965"><span class="lineNum">     965</span> <span class="tlaUNC">           0 :     white_d50.v = 1.0f;</span></span>
<span id="L966"><span class="lineNum">     966</span> <span class="tlaUNC">           0 :     white_d50.w = 0.8249f;</span></span>
<span id="L967"><span class="lineNum">     967</span>              : </span>
<span id="L968"><span class="lineNum">     968</span> <span class="tlaUNC">           0 :     pdf_cspace_init_Device(pdev-&gt;memory, &amp;alt_space, ncomps);    /* can't fail */</span></span>
<span id="L969"><span class="lineNum">     969</span> <span class="tlaUNC">           0 :     pcs-&gt;base_space = alt_space;</span></span>
<span id="L970"><span class="lineNum">     970</span> <span class="tlaUNC">           0 :     code = pdf_make_iccbased(pdev, NULL, pca, ncomps, prange, pcs,</span></span>
<span id="L971"><span class="lineNum">     971</span>              :                              &amp;pcstrm, pprange);</span>
<span id="L972"><span class="lineNum">     972</span> <span class="tlaUNC">           0 :     rc_decrement_cs(alt_space, &quot;pdf_convert_cie_to_iccbased&quot;);</span></span>
<span id="L973"><span class="lineNum">     973</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L974"><span class="lineNum">     974</span>              :         return code;</span>
<span id="L975"><span class="lineNum">     975</span>              : </span>
<span id="L976"><span class="lineNum">     976</span>              :     /* Fill in most of the header, except for the total size. */</span>
<span id="L977"><span class="lineNum">     977</span>              : </span>
<span id="L978"><span class="lineNum">     978</span> <span class="tlaUNC">           0 :     memset(header, 0, sizeof(header));</span></span>
<span id="L979"><span class="lineNum">     979</span> <span class="tlaUNC">           0 :     memcpy(header, header_data, sizeof(header_data));</span></span>
<span id="L980"><span class="lineNum">     980</span> <span class="tlaUNC">           0 :     memcpy(header + 16, dcsname, 4);</span></span>
<span id="L981"><span class="lineNum">     981</span>              : </span>
<span id="L982"><span class="lineNum">     982</span>              :     /* Construct the tables. */</span>
<span id="L983"><span class="lineNum">     983</span>              : </span>
<span id="L984"><span class="lineNum">     984</span>              :     /* desc */</span>
<span id="L985"><span class="lineNum">     985</span> <span class="tlaUNC">           0 :     memset(desc, 0, sizeof(desc));</span></span>
<span id="L986"><span class="lineNum">     986</span> <span class="tlaUNC">           0 :     memcpy(desc, desc_data, sizeof(desc_data));</span></span>
<span id="L987"><span class="lineNum">     987</span> <span class="tlaUNC">           0 :     DISCARD(add_table(&amp;next_table, &quot;desc&quot;, desc, sizeof(desc)));</span></span>
<span id="L988"><span class="lineNum">     988</span>              : </span>
<span id="L989"><span class="lineNum">     989</span>              :     /* wtpt. must be D50 */</span>
<span id="L990"><span class="lineNum">     990</span> <span class="tlaUNC">           0 :     add_table_xyz3(&amp;next_table, &quot;wtpt&quot;, wtpt, &amp;white_d50);</span></span>
<span id="L991"><span class="lineNum">     991</span> <span class="tlaUNC">           0 :     memcpy(header + 68, wtpt + 8, 12); /* illuminant = white point */</span></span>
<span id="L992"><span class="lineNum">     992</span>              : </span>
<span id="L993"><span class="lineNum">     993</span>              :     /* cprt */</span>
<span id="L994"><span class="lineNum">     994</span>              :     /* (We have no use for this tag, but icclib requires it.) */</span>
<span id="L995"><span class="lineNum">     995</span> <span class="tlaUNC">           0 :     DISCARD(add_table(&amp;next_table, &quot;cprt&quot;, cprt_data, sizeof(cprt_data)));</span></span>
<span id="L996"><span class="lineNum">     996</span>              : </span>
<span id="L997"><span class="lineNum">     997</span>              :     /* Use TRC + XYZ if possible, otherwise AToB. */</span>
<span id="L998"><span class="lineNum">     998</span> <span class="tlaUNC">           0 :     if ((one_step == ONE_STEP_ABC || one_step == ONE_STEP_LMN) &amp;&amp; pmat != 0) {</span></span>
<span id="L999"><span class="lineNum">     999</span>              :         /* Use TRC + XYZ. */</span>
<span id="L1000"><span class="lineNum">    1000</span> <span class="tlaUNC">           0 :         profile_table_t *tr =</span></span>
<span id="L1001"><span class="lineNum">    1001</span> <span class="tlaUNC">           0 :             add_trc(pdev, &amp;next_table, &quot;rTRC&quot;, rTRC, pciec, one_step);</span></span>
<span id="L1002"><span class="lineNum">    1002</span> <span class="tlaUNC">           0 :         profile_table_t *tg =</span></span>
<span id="L1003"><span class="lineNum">    1003</span> <span class="tlaUNC">           0 :             add_trc(pdev, &amp;next_table, &quot;gTRC&quot;, gTRC, pciec, one_step);</span></span>
<span id="L1004"><span class="lineNum">    1004</span> <span class="tlaUNC">           0 :         profile_table_t *tb =</span></span>
<span id="L1005"><span class="lineNum">    1005</span> <span class="tlaUNC">           0 :             add_trc(pdev, &amp;next_table, &quot;bTRC&quot;, bTRC, pciec, one_step);</span></span>
<span id="L1006"><span class="lineNum">    1006</span>              : </span>
<span id="L1007"><span class="lineNum">    1007</span> <span class="tlaUNC">           0 :         if (*pprange) {</span></span>
<span id="L1008"><span class="lineNum">    1008</span> <span class="tlaUNC">           0 :             tr-&gt;ranges = *pprange;</span></span>
<span id="L1009"><span class="lineNum">    1009</span> <span class="tlaUNC">           0 :             tg-&gt;ranges = *pprange + 1;</span></span>
<span id="L1010"><span class="lineNum">    1010</span> <span class="tlaUNC">           0 :             tb-&gt;ranges = *pprange + 2;</span></span>
<span id="L1011"><span class="lineNum">    1011</span>              :         }</span>
<span id="L1012"><span class="lineNum">    1012</span>              :         /* These values need to be adjusted to D50.  Again</span>
<span id="L1013"><span class="lineNum">    1013</span>              :            use XYZ wp mapping for now.  Later we will add in</span>
<span id="L1014"><span class="lineNum">    1014</span>              :            the bradford stuff */</span>
<span id="L1015"><span class="lineNum">    1015</span> <span class="tlaUNC">           0 :         adjust_wp(&amp;(pmat-&gt;cu), &amp;(pciec-&gt;points.WhitePoint), &amp;temp_xyz, &amp;white_d50);</span></span>
<span id="L1016"><span class="lineNum">    1016</span> <span class="tlaUNC">           0 :         add_table_xyz3(&amp;next_table, &quot;rXYZ&quot;, rXYZ, &amp;temp_xyz);</span></span>
<span id="L1017"><span class="lineNum">    1017</span> <span class="tlaUNC">           0 :         adjust_wp(&amp;(pmat-&gt;cv), &amp;(pciec-&gt;points.WhitePoint), &amp;temp_xyz, &amp;white_d50);</span></span>
<span id="L1018"><span class="lineNum">    1018</span> <span class="tlaUNC">           0 :         add_table_xyz3(&amp;next_table, &quot;gXYZ&quot;, gXYZ, &amp;temp_xyz);</span></span>
<span id="L1019"><span class="lineNum">    1019</span> <span class="tlaUNC">           0 :         adjust_wp(&amp;(pmat-&gt;cw), &amp;(pciec-&gt;points.WhitePoint), &amp;temp_xyz, &amp;white_d50);</span></span>
<span id="L1020"><span class="lineNum">    1020</span> <span class="tlaUNC">           0 :         add_table_xyz3(&amp;next_table, &quot;bXYZ&quot;, bXYZ, &amp;temp_xyz);</span></span>
<span id="L1021"><span class="lineNum">    1021</span>              :     } else {</span>
<span id="L1022"><span class="lineNum">    1022</span>              :         /* General case, use a lookup table. */</span>
<span id="L1023"><span class="lineNum">    1023</span>              :         /* AToB (mft2) */</span>
<span id="L1024"><span class="lineNum">    1024</span> <span class="tlaUNC">           0 :         profile_table_t *pnt = add_a2b0(&amp;next_table, &amp;a2b0, ncomps, pcs);</span></span>
<span id="L1025"><span class="lineNum">    1025</span>              : </span>
<span id="L1026"><span class="lineNum">    1026</span> <span class="tlaUNC">           0 :         pnt-&gt;ranges = *pprange;</span></span>
<span id="L1027"><span class="lineNum">    1027</span>              :     }</span>
<span id="L1028"><span class="lineNum">    1028</span>              : </span>
<span id="L1029"><span class="lineNum">    1029</span>              :     /* Write the profile. */</span>
<span id="L1030"><span class="lineNum">    1030</span>              :     {</span>
<span id="L1031"><span class="lineNum">    1031</span> <span class="tlaUNC">           0 :         byte bytes[4 + MAX_NUM_TABLES * 12];</span></span>
<span id="L1032"><span class="lineNum">    1032</span> <span class="tlaUNC">           0 :         int num_tables = next_table - tables;</span></span>
<span id="L1033"><span class="lineNum">    1033</span> <span class="tlaUNC">           0 :         int i;</span></span>
<span id="L1034"><span class="lineNum">    1034</span> <span class="tlaUNC">           0 :         byte *p;</span></span>
<span id="L1035"><span class="lineNum">    1035</span> <span class="tlaUNC">           0 :         uint table_size = 4 + num_tables * 12;</span></span>
<span id="L1036"><span class="lineNum">    1036</span> <span class="tlaUNC">           0 :         uint offset = sizeof(header) + table_size;</span></span>
<span id="L1037"><span class="lineNum">    1037</span>              : </span>
<span id="L1038"><span class="lineNum">    1038</span> <span class="tlaUNC">           0 :         set_uint32(bytes, next_table - tables);</span></span>
<span id="L1039"><span class="lineNum">    1039</span> <span class="tlaUNC">           0 :         for (i = 0, p = bytes + 4; i &lt; num_tables; ++i, p += 12) {</span></span>
<span id="L1040"><span class="lineNum">    1040</span> <span class="tlaUNC">           0 :             memcpy(p, tables[i].tag, 4);</span></span>
<span id="L1041"><span class="lineNum">    1041</span> <span class="tlaUNC">           0 :             set_uint32(p + 4, offset);</span></span>
<span id="L1042"><span class="lineNum">    1042</span> <span class="tlaUNC">           0 :             set_uint32(p + 8, tables[i].length);</span></span>
<span id="L1043"><span class="lineNum">    1043</span> <span class="tlaUNC">           0 :             offset += round_up(tables[i].length, 4);</span></span>
<span id="L1044"><span class="lineNum">    1044</span>              :         }</span>
<span id="L1045"><span class="lineNum">    1045</span> <span class="tlaUNC">           0 :         set_uint32(header, offset);</span></span>
<span id="L1046"><span class="lineNum">    1046</span> <span class="tlaUNC">           0 :         if ((code = cos_stream_add_bytes(pdev, pcstrm, header, sizeof(header))) &lt; 0 ||</span></span>
<span id="L1047"><span class="lineNum">    1047</span> <span class="tlaUNC">           0 :             (code = cos_stream_add_bytes(pdev, pcstrm, bytes, table_size)) &lt; 0</span></span>
<span id="L1048"><span class="lineNum">    1048</span>              :             )</span>
<span id="L1049"><span class="lineNum">    1049</span> <span class="tlaUNC">           0 :             return code;</span></span>
<span id="L1050"><span class="lineNum">    1050</span> <span class="tlaUNC">           0 :         for (i = 0; i &lt; num_tables; ++i) {</span></span>
<span id="L1051"><span class="lineNum">    1051</span> <span class="tlaUNC">           0 :             uint len = tables[i].data_length;</span></span>
<span id="L1052"><span class="lineNum">    1052</span> <span class="tlaUNC">           0 :             static const byte pad[3] = {0, 0, 0};</span></span>
<span id="L1053"><span class="lineNum">    1053</span>              : </span>
<span id="L1054"><span class="lineNum">    1054</span> <span class="tlaUNC">           0 :             if ((code = cos_stream_add_bytes(pdev, pcstrm, tables[i].data, len)) &lt; 0 ||</span></span>
<span id="L1055"><span class="lineNum">    1055</span> <span class="tlaUNC">           0 :                 (tables[i].write != 0 &amp;&amp;</span></span>
<span id="L1056"><span class="lineNum">    1056</span> <span class="tlaUNC">           0 :                  (code = tables[i].write(pdev, pcstrm, &amp;tables[i], pdev-&gt;pdf_memory, pciec)) &lt; 0) ||</span></span>
<span id="L1057"><span class="lineNum">    1057</span> <span class="tlaUNC">           0 :                 (code = cos_stream_add_bytes(pdev, pcstrm, pad,</span></span>
<span id="L1058"><span class="lineNum">    1058</span> <span class="tlaUNC">           0 :                         -(int)(tables[i].length) &amp; 3)) &lt; 0</span></span>
<span id="L1059"><span class="lineNum">    1059</span>              :                 )</span>
<span id="L1060"><span class="lineNum">    1060</span> <span class="tlaUNC">           0 :                 return code;</span></span>
<span id="L1061"><span class="lineNum">    1061</span>              :         }</span>
<span id="L1062"><span class="lineNum">    1062</span>              :     }</span>
<span id="L1063"><span class="lineNum">    1063</span>              : </span>
<span id="L1064"><span class="lineNum">    1064</span> <span class="tlaUNC">           0 :     return pdf_finish_iccbased(pdev, pcstrm);</span></span>
<span id="L1065"><span class="lineNum">    1065</span>              : }</span>
<span id="L1066"><span class="lineNum">    1066</span>              : </span>
<span id="L1067"><span class="lineNum">    1067</span>              : /* ------ Entry points (from gdevpdfc.c) ------ */</span>
<span id="L1068"><span class="lineNum">    1068</span>              : </span>
<span id="L1069"><span class="lineNum">    1069</span>              : /*</span>
<span id="L1070"><span class="lineNum">    1070</span>              :  * Create an ICCBased color space.  This is a single-use procedure,</span>
<span id="L1071"><span class="lineNum">    1071</span>              :  * broken out only for readability.</span>
<span id="L1072"><span class="lineNum">    1072</span>              :  */</span>
<span id="L1073"><span class="lineNum">    1073</span>              : int</span>
<span id="L1074"><span class="lineNum">    1074</span> <span class="tlaUNC">           0 : pdf_iccbased_color_space(gx_device_pdf *pdev, const gs_gstate * pgs, cos_value_t *pvalue,</span></span>
<span id="L1075"><span class="lineNum">    1075</span>              :                          const gs_color_space *pcs, cos_array_t *pca)</span>
<span id="L1076"><span class="lineNum">    1076</span>              : {</span>
<span id="L1077"><span class="lineNum">    1077</span> <span class="tlaUNC">           0 :     cos_stream_t * pcstrm;</span></span>
<span id="L1078"><span class="lineNum">    1078</span> <span class="tlaUNC">           0 :     int code = 0, code1 = 0;</span></span>
<span id="L1079"><span class="lineNum">    1079</span> <span class="tlaUNC">           0 :     unsigned char major = 0, minor = 0;</span></span>
<span id="L1080"><span class="lineNum">    1080</span> <span class="tlaUNC">           0 :     bool downgrade_icc = false;</span></span>
<span id="L1081"><span class="lineNum">    1081</span> <span class="tlaUNC">           0 :     pdf_resource_t *pres = NULL;</span></span>
<span id="L1082"><span class="lineNum">    1082</span>              : </span>
<span id="L1083"><span class="lineNum">    1083</span>              :     /*</span>
<span id="L1084"><span class="lineNum">    1084</span>              :      * This would arise only in a pdf ==&gt; pdf translation, but we</span>
<span id="L1085"><span class="lineNum">    1085</span>              :      * should allow for it anyway.</span>
<span id="L1086"><span class="lineNum">    1086</span>              :      */</span>
<span id="L1087"><span class="lineNum">    1087</span>              :     /* Not all ICC profile types are valid for embedding in a PDF file.</span>
<span id="L1088"><span class="lineNum">    1088</span>              :      * The code here duplicates a check in zicc.c, .numicc_components()</span>
<span id="L1089"><span class="lineNum">    1089</span>              :      * where we check to see if an embedded profile is valid. Because</span>
<span id="L1090"><span class="lineNum">    1090</span>              :      * we could be getting input from other sources, we need to do the same</span>
<span id="L1091"><span class="lineNum">    1091</span>              :      * check here. If the profile can't be embedded in PDF, then we</span>
<span id="L1092"><span class="lineNum">    1092</span>              :      * return gs_error_rangecheck which will cause pdfwrtie to fall back</span>
<span id="L1093"><span class="lineNum">    1093</span>              :      * to the device space. At least the PDF file will be valid and have</span>
<span id="L1094"><span class="lineNum">    1094</span>              :      * 'correct' colours.</span>
<span id="L1095"><span class="lineNum">    1095</span>              :      */</span>
<span id="L1096"><span class="lineNum">    1096</span> <span class="tlaUNC">           0 :     switch (pcs-&gt;cmm_icc_profile_data-&gt;data_cs) {</span></span>
<span id="L1097"><span class="lineNum">    1097</span>              :         case gsCIEXYZ:</span>
<span id="L1098"><span class="lineNum">    1098</span>              :         case gsCIELAB:</span>
<span id="L1099"><span class="lineNum">    1099</span>              :         case gsRGB:</span>
<span id="L1100"><span class="lineNum">    1100</span>              :         case gsGRAY:</span>
<span id="L1101"><span class="lineNum">    1101</span>              :         case gsCMYK:</span>
<span id="L1102"><span class="lineNum">    1102</span>              :             break;</span>
<span id="L1103"><span class="lineNum">    1103</span> <span class="tlaUNC">           0 :         case gsUNDEFINED:</span></span>
<span id="L1104"><span class="lineNum">    1104</span>              :         case gsNCHANNEL:</span>
<span id="L1105"><span class="lineNum">    1105</span>              :         case gsNAMED:</span>
<span id="L1106"><span class="lineNum">    1106</span> <span class="tlaUNC">           0 :             emprintf(pdev-&gt;memory, &quot;\n An ICC profile which is not suitable for use in PDF has been identified.\n All colours using this profile will be converted into device space\n instead and the profile will not be used.\n&quot;);</span></span>
<span id="L1107"><span class="lineNum">    1107</span> <span class="tlaUNC">           0 :             return gs_error_rangecheck;</span></span>
<span id="L1108"><span class="lineNum">    1108</span> <span class="tlaUNC">           0 :             break;</span></span>
<span id="L1109"><span class="lineNum">    1109</span>              :     }</span>
<span id="L1110"><span class="lineNum">    1110</span>              : </span>
<span id="L1111"><span class="lineNum">    1111</span> <span class="tlaUNC">           0 :     code =</span></span>
<span id="L1112"><span class="lineNum">    1112</span> <span class="tlaUNC">           0 :         pdf_make_iccbased(pdev, pgs, pca, pcs-&gt;cmm_icc_profile_data-&gt;num_comps,</span></span>
<span id="L1113"><span class="lineNum">    1113</span> <span class="tlaUNC">           0 :                           pcs-&gt;cmm_icc_profile_data-&gt;Range.ranges,</span></span>
<span id="L1114"><span class="lineNum">    1114</span>              :                           pcs,</span>
<span id="L1115"><span class="lineNum">    1115</span>              :                           &amp;pcstrm, NULL);</span>
<span id="L1116"><span class="lineNum">    1116</span>              : </span>
<span id="L1117"><span class="lineNum">    1117</span> <span class="tlaUNC">           0 :     if (code &lt; 0)</span></span>
<span id="L1118"><span class="lineNum">    1118</span>              :         return code;</span>
<span id="L1119"><span class="lineNum">    1119</span>              : </span>
<span id="L1120"><span class="lineNum">    1120</span>              :     /* Transfer the buffer data  */</span>
<span id="L1121"><span class="lineNum">    1121</span>              : </span>
<span id="L1122"><span class="lineNum">    1122</span> <span class="tlaUNC">           0 :     (void)gsicc_getprofilevers(pcs-&gt;cmm_icc_profile_data, &amp;major, &amp;minor);</span></span>
<span id="L1123"><span class="lineNum">    1123</span> <span class="tlaUNC">           0 :     minor = minor &gt;&gt; 4;</span></span>
<span id="L1124"><span class="lineNum">    1124</span>              : </span>
<span id="L1125"><span class="lineNum">    1125</span>              :     /* Determine whether we need to get the CMS to give us an earlier ICC version</span>
<span id="L1126"><span class="lineNum">    1126</span>              :      * of the profile.</span>
<span id="L1127"><span class="lineNum">    1127</span>              :      */</span>
<span id="L1128"><span class="lineNum">    1128</span> <span class="tlaUNC">           0 :     if (pdev-&gt;CompatibilityLevel &lt; 1.3) {</span></span>
<span id="L1129"><span class="lineNum">    1129</span>              :         return_error(gs_error_rangecheck);</span>
<span id="L1130"><span class="lineNum">    1130</span>              :     } else {</span>
<span id="L1131"><span class="lineNum">    1131</span> <span class="tlaUNC">           0 :         if (pdev-&gt;CompatibilityLevel &lt; 1.5) {</span></span>
<span id="L1132"><span class="lineNum">    1132</span> <span class="tlaUNC">           0 :             if (major &gt; 2)</span></span>
<span id="L1133"><span class="lineNum">    1133</span>              :                 downgrade_icc = true;</span>
<span id="L1134"><span class="lineNum">    1134</span>              :         } else {</span>
<span id="L1135"><span class="lineNum">    1135</span> <span class="tlaUNC">           0 :             if (pdev-&gt;CompatibilityLevel == 1.5) {</span></span>
<span id="L1136"><span class="lineNum">    1136</span> <span class="tlaUNC">           0 :                 if (major &gt; 4 || minor &gt; 0)</span></span>
<span id="L1137"><span class="lineNum">    1137</span>              :                     downgrade_icc = true;</span>
<span id="L1138"><span class="lineNum">    1138</span>              :             } else {</span>
<span id="L1139"><span class="lineNum">    1139</span> <span class="tlaUNC">           0 :                 if (pdev-&gt;CompatibilityLevel == 1.6) {</span></span>
<span id="L1140"><span class="lineNum">    1140</span> <span class="tlaUNC">           0 :                     if (major &gt; 4 || minor &gt; 1)</span></span>
<span id="L1141"><span class="lineNum">    1141</span>              :                         downgrade_icc = true;</span>
<span id="L1142"><span class="lineNum">    1142</span>              :                 } else {</span>
<span id="L1143"><span class="lineNum">    1143</span> <span class="tlaUNC">           0 :                     if (major &gt; 4 || minor &gt; 2)</span></span>
<span id="L1144"><span class="lineNum">    1144</span>              :                         downgrade_icc = true;</span>
<span id="L1145"><span class="lineNum">    1145</span>              :                 }</span>
<span id="L1146"><span class="lineNum">    1146</span>              :             }</span>
<span id="L1147"><span class="lineNum">    1147</span>              :         }</span>
<span id="L1148"><span class="lineNum">    1148</span>              :     }</span>
<span id="L1149"><span class="lineNum">    1149</span>              : </span>
<span id="L1150"><span class="lineNum">    1150</span>              :     if (downgrade_icc) {</span>
<span id="L1151"><span class="lineNum">    1151</span> <span class="tlaUNC">           0 :         byte *v2_buffer;</span></span>
<span id="L1152"><span class="lineNum">    1152</span> <span class="tlaUNC">           0 :         int size;</span></span>
<span id="L1153"><span class="lineNum">    1153</span>              : </span>
<span id="L1154"><span class="lineNum">    1154</span> <span class="tlaUNC">           0 :         if (pgs == NULL)</span></span>
<span id="L1155"><span class="lineNum">    1155</span> <span class="tlaUNC">           0 :             return (gs_error_undefined);</span></span>
<span id="L1156"><span class="lineNum">    1156</span> <span class="tlaUNC">           0 :         if (pcs-&gt;cmm_icc_profile_data-&gt;profile_handle == NULL)</span></span>
<span id="L1157"><span class="lineNum">    1157</span> <span class="tlaUNC">           0 :             gsicc_initialize_default_profile(pcs-&gt;cmm_icc_profile_data);</span></span>
<span id="L1158"><span class="lineNum">    1158</span> <span class="tlaUNC">           0 :         v2_buffer = gsicc_create_getv2buffer(pgs, pcs-&gt;cmm_icc_profile_data, &amp;size);</span></span>
<span id="L1159"><span class="lineNum">    1159</span> <span class="tlaUNC">           0 :         code = cos_stream_add_bytes(pdev, pcstrm, v2_buffer, size);</span></span>
<span id="L1160"><span class="lineNum">    1160</span>              :     }else{</span>
<span id="L1161"><span class="lineNum">    1161</span> <span class="tlaUNC">           0 :         code = cos_stream_add_bytes(pdev, pcstrm, pcs-&gt;cmm_icc_profile_data-&gt;buffer,</span></span>
<span id="L1162"><span class="lineNum">    1162</span> <span class="tlaUNC">           0 :         pcs-&gt;cmm_icc_profile_data-&gt;buffer_size);</span></span>
<span id="L1163"><span class="lineNum">    1163</span>              :     }</span>
<span id="L1164"><span class="lineNum">    1164</span>              : </span>
<span id="L1165"><span class="lineNum">    1165</span>              :     /*</span>
<span id="L1166"><span class="lineNum">    1166</span>              :      * The stream has been added to the array: However because the stream cos object</span>
<span id="L1167"><span class="lineNum">    1167</span>              :      * has an id (it has to be an indirect object), freeing the colour space won't</span>
<span id="L1168"><span class="lineNum">    1168</span>              :      * free the ICC profile stream. In order to have the stream freed we must add it to</span>
<span id="L1169"><span class="lineNum">    1169</span>              :      * a resource chain; we don't have a resource chain for ICC profiles, so add it to</span>
<span id="L1170"><span class="lineNum">    1170</span>              :      * resourceOther instead. This means it will be among the last objects released.</span>
<span id="L1171"><span class="lineNum">    1171</span>              :      */</span>
<span id="L1172"><span class="lineNum">    1172</span> <span class="tlaUNC">           0 :     code1 = pdf_alloc_resource(pdev, resourceOther, pcstrm-&gt;id, &amp;pres, -1);</span></span>
<span id="L1173"><span class="lineNum">    1173</span> <span class="tlaUNC">           0 :     if (code1 &gt;= 0) {</span></span>
<span id="L1174"><span class="lineNum">    1174</span> <span class="tlaUNC">           0 :         COS_FREE(pres-&gt;object, &quot;pdf_iccbased_color_space&quot;);</span></span>
<span id="L1175"><span class="lineNum">    1175</span> <span class="tlaUNC">           0 :         pres-&gt;object = (cos_object_t *)pcstrm;</span></span>
<span id="L1176"><span class="lineNum">    1176</span>              :     }</span>
<span id="L1177"><span class="lineNum">    1177</span>              : </span>
<span id="L1178"><span class="lineNum">    1178</span> <span class="tlaUNC">           0 :     if (code &gt;= 0)</span></span>
<span id="L1179"><span class="lineNum">    1179</span> <span class="tlaUNC">           0 :         code = pdf_finish_iccbased(pdev, pcstrm);</span></span>
<span id="L1180"><span class="lineNum">    1180</span>              : </span>
<span id="L1181"><span class="lineNum">    1181</span>              :     return code;</span>
<span id="L1182"><span class="lineNum">    1182</span>              : }</span>
<span id="L1183"><span class="lineNum">    1183</span>              : </span>
<span id="L1184"><span class="lineNum">    1184</span>              : /* Convert a CIEBased space to Lab or ICCBased. */</span>
<span id="L1185"><span class="lineNum">    1185</span>              : int</span>
<span id="L1186"><span class="lineNum">    1186</span> <span class="tlaUNC">           0 : pdf_convert_cie_space(gx_device_pdf *pdev, cos_array_t *pca,</span></span>
<span id="L1187"><span class="lineNum">    1187</span>              :                       const gs_color_space *pcs, const char *dcsname,</span>
<span id="L1188"><span class="lineNum">    1188</span>              :                       const gs_cie_common *pciec, const gs_range *prange,</span>
<span id="L1189"><span class="lineNum">    1189</span>              :                       cie_cache_one_step_t one_step, const gs_matrix3 *pmat,</span>
<span id="L1190"><span class="lineNum">    1190</span>              :                       const gs_range_t **pprange)</span>
<span id="L1191"><span class="lineNum">    1191</span>              : {</span>
<span id="L1192"><span class="lineNum">    1192</span> <span class="tlaUNC">           0 :     return (pdev-&gt;CompatibilityLevel &lt; 1.3 ?</span></span>
<span id="L1193"><span class="lineNum">    1193</span>              :             /* PDF 1.2 or earlier, use a Lab space. */</span>
<span id="L1194"><span class="lineNum">    1194</span> <span class="tlaUNC">           0 :             pdf_convert_cie_to_lab(pdev, pca, pcs, pciec, prange) :</span></span>
<span id="L1195"><span class="lineNum">    1195</span>              :             /* PDF 1.3 or later, use an ICCBased space. */</span>
<span id="L1196"><span class="lineNum">    1196</span> <span class="tlaUNC">           0 :             pdf_convert_cie_to_iccbased(pdev, pca, (gs_color_space *)pcs, dcsname, pciec, prange,</span></span>
<span id="L1197"><span class="lineNum">    1197</span>              :                                         one_step, pmat, pprange)</span>
<span id="L1198"><span class="lineNum">    1198</span>              :             );</span>
<span id="L1199"><span class="lineNum">    1199</span>              : }</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
